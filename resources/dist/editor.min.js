class Area{constructor(e){return this.Name=e.Name,this.Color=e.Color,this.Type=e.Type,this.Replicates=e.Replicates||1,this.Direction=e.Direction||"Horizontal",this.Priority=e.Priority||"Row",this.Custom=e.Custom,this.Definition=void 0,this.MaxRange=0,this.DefInfo="none",this.Tags=[],"Range"==e.Type&&Area.rangeInfo(this),this}static log(e,t,i){if(0==e.Tags.length)e.Tags.push({Layer:t,Wells:[i]});else{let a=e.Tags.findIndex((function(e){return e.Layer.Index==t.Index}));a>-1?e.Tags[a].Wells.push(i):e.Tags.push({Layer:t,Wells:[i]})}}static unlog(e,t,i){let a=e.Tags.findIndex((function(e){return e.Layer.Index==t.Index}));a>-1&&(e.Tags[a].Wells=e.Tags[a].Wells.filter((function(e){return e.Index!=i.Index})))}static form(e){let t=e.ID,i=t+"_Input",a=t+"_InputRange",n=t+"_InputRange_Options",l=t+"_InputRange_Custom",s="New Area";e.Edit&&(s="Edit Area");let r={Name:LinkCtrl.new("Text",{ID:i,Default:"",Label:"Name",Title:"The name of the area",Chain:{Index:0}}),Color:LinkCtrl.new("Color",{ID:i,Default:e.Color,Label:"Color",Title:"The color that will be used to represent this area",Chain:{Index:1,Last:!0},NewLine:!0}),Type:LinkCtrl.new("Select",{ID:i,Index:2,Default:2,Label:"Type",Title:"The type of area to create",Preserve:!0,List:["Positive Control","Negative Control","Sample","Range"],Change:function(e){3==e?(GetId(a).style.display="block",Object.values(o).forEach((function(e){e.init()})),o.Custom.Value?GetId(n).style.display="none":GetId(n).style.display="block"):GetId(a).style.display="none"}})},o={Replicates:LinkCtrl.new("Number",{ID:n,Index:0,Default:10,Label:"Replicates",Title:"Number of replicates for the range. Should be between 1 and 1536",NewLine:!0,Min:1,Max:1536}),Direction:LinkCtrl.new("Radio",{ID:n,Index:1,Default:0,Label:"Direction",Title:"Direction of the replicates",NewLine:!0,Preserve:!0,List:["Horizontal","Vertical"]}),Priority:LinkCtrl.new("Radio",{ID:n,Index:2,Default:0,Label:"Priority",Title:"Wether numbering should be done per rows or per cols",NewLine:!0,Preserve:!0,List:["Row","Col"]}),Custom:LinkCtrl.new("Checkbox",{ID:l,Index:3,Default:0,Label:"Custom",Change:function(e){let t=GetId(n);0==e?(t.style.display="block",t.insertAdjacentHTML("beforeend",'<div class="Error" style="padding: 5px; text-align: center">When leaving custom mode, all exisiting custom numbering will be recomputed using the options specified above</div>')):("DIV"==t.lastChild.nodeName&&t.lastChild.remove(),t.style.display="none")},Title:"Tick to allow customized numbering after each tagging"})};if(e.Edit){r.Name.setValue(e.Area.Name);let t=e.Area.Type;r.Type.setValue(r.Type.List.findIndex((function(e){return e==t}))),"Range"==t&&(o.Replicates.setValue(e.Area.Replicates),o.Direction.setValue(o.Direction.List.findIndex((function(t){return t==e.Area.Direction}))),o.Priority.setValue(o.Priority.List.findIndex((function(t){return t==e.Area.Priority}))),o.Custom.setValue(e.Area.Custom))}let h=[{Label:"Ok",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){e.Ok(r,o)}}];void 0===e.Edit&&h.push({Label:"Add another",Icon:{Type:"New",Space:!0},Click:function(){e.Another(r,o)}}),h.push({Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(t)}}),Form.open({ID:t,HTML:'<div id="'+i+'"></div><fieldset id="'+a+'" style="display: none; margin-top: 5px"><legend>Numbering</legend><div id="'+n+'"></div><div id="'+l+'"></div></fieldset>',Title:s,Buttons:h,onInit:function(){Object.values(r).forEach((function(e){e.init()})),e.Edit&&(r.Type.disable(),"Range"==e.Area.Type&&r.Type.change(r.Type.Value)),r.Name.focus()}})}static fetchRangeItem(e,t,i){if(e.Definition)return e.Definition.item(t);{let a="#"+t.RangeIndex;return i&&i.OutputName&&(a=e.Name+" ("+a+")"),Promise.resolve(a)}}static rangeInfo(e){if(e.Custom)e.Other="Custom";else{let t="";t="Horizontal"==e.Direction?", &rarr;":", &darr;",void 0===e.Priority||"Row"==e.Priority?t+="R":t+="C",e.Other=e.Replicates+"&times;"+t}e.MaxRange>0&&(e.Other+="<br>"+e.MaxRange+" counts")}static save(e){let t=[];return e.Tags.forEach((function(e){let i=[];e.Wells.forEach((function(e){i.push(Well.save(e))})),t.push({Layer:e.Layer.Index,Wells:i})})),JSON.stringify({Name:e.Name,Color:e.Color,Type:e.Type,Replicates:e.Replicates,Direction:e.Direction,Priority:e.Priority,Custom:e.Custom,Tags:t})}static loadPreview(e,t){let i='<table class="RespTable"><tr><th>#</th><th>Name</th><th>Color</th><th>Type</th><th>Tags</th></tr>';e&&e.length>0?(e.forEach((function(e,t){i+="<tr><td>"+(t+1)+"</td><td>"+e.Name+"</td>",i+='<td><span style="background-color: '+e.Color+'; border: 1px solid black">&nbsp;&nbsp;&nbsp;&nbsp;</span></td>',i+="<td>"+e.Type,"Range"==e.Type&&(Area.rangeInfo(e),i+=" ("+e.Other+")"),i+="</td><td>",e.Tags?i+=e.Tags.reduce((function(e,t){return e+t.Wells.length}),0):i+=0,i+="</td></tr>"})),i+="</table>"):i='<p class="Error">No data</p>',GetId(t).insertAdjacentHTML("beforeend",i)}static load(e,t,i,a){t.forEach((function(t){let n=void 0;if(n="Range"==t.Type?e.addRow(new Area({Name:t.Name,Color:t.Color,Type:t.Type,Replicates:t.Replicates,Direction:t.Direction,Priority:t.Priority,Custom:t.Custom})):e.addRow(new Area({Name:t.Name,Color:t.Color,Type:t.Type})),a){let e=i.TypeMap;t.Tags.forEach((function(a){let l=i.Layers[a.Layer];a.Wells.forEach((function(i){let a=l.Wells[i.Index];a&&(a.Area=n,"Range"==t.Type&&t.Custom&&(a.RangeIndex=i.RangeIndex),e.log(i.Index,t.Type),Area.log(n,l,a))}))})),"Range"==t.Type&&i.updateRange(n)}}))}static resize(e,t,i,a){e.forEach((function(e){e.Tags.forEach((function(e){let t=[];e.Wells.forEach((function(e){e.Row<i&&e.Col<a&&t.push(e)})),e.Wells=t})),"Range"==e.Type&&e.updateRange(t.WellSize,t.WellMargin)}))}static plateDefinition(e,t){let i=Array(Editor.Plate.Rows*Editor.Plate.Cols).fill("");return e.Tags.forEach((function(e){e.Wells.forEach((function(e){let a=e.Index;0==i[a].length?i[a]=t[e.RangeIndex-1]:i[a]+=" "+t[e.RangeIndex-1]}))})),i}static getControls(e){let t=[],i=[];return e.forEach((function(e){if("Positive Control"==e.Type||"Negative Control"==e.Type){let a=Area.taggedWells(e),n={Name:e.Name,Tags:a.W,Conc:a.C};"Positive Control"==e.Type?t.push(n):i.push(n)}})),{P:t,N:i,Count:t.length+i.length}}static getAreas(e){let t=[],i=[],a=0;return e.forEach((function(e){let n=Area.taggedWells(e);"Range"==e.Type?i.push({Name:e.Name,Tags:n.W,Conc:n.C,Type:e.Type,Definition:e.Definition,Values:Area.taggedWellsRangeIndex(e)}):t.push({Name:e.Name,Tags:n.W,Conc:n.C,Type:e.Type}),a++})),{A:t,R:i,Count:a}}static getRanges(e){let t=Editor.Tables.Areas.Array.filter((function(e){return"Range"==e.Type}));return e&&e.HasDefinition?t.filter((function(e){return e.Definition})):t}static taggedWells(e,t){let i=[],a=[];return e.Tags.forEach((function(e){e.Wells.forEach((function(e){let n=e.Index;t&&t.ByName&&(n=e.Name),0==i.includes(n)&&(i.push(n),a.push(Well.dose(e)))}))})),{W:i,C:a}}static taggedWellsRangeIndex(e){let t=[];return e.Tags.forEach((function(i){i.Wells.forEach((function(i){let a=i.RangeIndex,n=a-1,l=e.Name+" #"+a;t[n]?0==t[n].Tags.includes(i.Index)&&(t[n].Tags.push(i.Index),t[n].Conc.push(Well.dose(i))):t[n]={Name:l,Type:"Range",RangeIndex:a,Tags:[i.Index],Conc:[Well.dose(i)],Value:a}}))})),t}static setPriority(e,t,i){let a=e.length,n=0,l=[],s=function(t){return e[t]?"Col"==i?e[t].Row:e[t].Col:-1},r=s(0);for(;n<a;){let i=0,a=!0;for(;i<t&&a;){let e=s(i);e!=r?(a=!1,r=e):i++}i>0&&(l.push(e.splice(0,i)),n+=i)}return"Col"==i?l.sort((function(e,t){return e[0].Col-t[0].Col})):l.sort((function(e,t){return e[0].Row-t[0].Row})),l.reduce((function(e,t){return e.concat(t)}),[])}get Tagged(){let e=0;return this.Tags.forEach((function(t){e+=t.Wells.length})),e}update(e,t){"Range"==this.Type?this.updateRange(e,t):this.Tags.forEach((function(i){let a=i.Layer.Contents.getContext("2d");i.Wells.forEach((function(i){i.content(a,e,t)}))}))}updateRange(e,t){let i=0,a=this.Replicates,n=0;this.Direction,this.Priority;return this.Tags.sort((function(e,t){return e.Layer.Index-t.Layer.Index})),this.Tags.forEach((function(l){if(this.Custom)l.Wells.forEach((function(e){n=Math.max(n,e.RangeIndex)}));else{"Horizontal"==this.Direction?(l.Wells.sort((function(e,t){return e.Index-t.Index})),a>1&&"Col"==this.Priority&&(l.Wells=Area.setPriority(l.Wells,a,"Col"))):(l.Wells.sort((function(e,t){return e.Col-t.Col||e.Row-t.Row})),a>1&&"Row"==this.Priority&&(l.Wells=Area.setPriority(l.Wells,a,"Row")));let s=l.Layer.Contents.getContext("2d");l.Wells.forEach((function(l){n=Math.floor(i/a)+1,l.RangeIndex=n,l.content(s,e,t),i++}))}}),this),this.MaxRange=n,this.Definition&&this.Definition.update(),Area.rangeInfo(this),this}removeTags(e){e.Map;let t=e.WellSize,i=e.WellMargin;return this.Tags.forEach((function(a){let n=a.Layer.Contents.getContext("2d"),l=a.Layer.Index;a.Wells.forEach((function(a){e.TypeMap.unlog(a.Index,l),a.Area=void 0,a.content(n,t,i)}))})),this}removeDefinition(){return this.Definition=void 0,this.DefInfo="none",this}}class EditorConsole{constructor(e){return this.ID=e,this.MaxLog=20,this.CurrentLog=0,this}static message(e,t){let i="";switch(e){case"Error":i+=LinkCtrl.icon({Type:"Cancel",Color:"Red"})+'<span style="color: firebrick">';break;case"Warning":i+=LinkCtrl.icon({Type:"Warning",Color:"Yellow"})+'<span style="color: sienna">';break;case"Success":i+=LinkCtrl.icon({Type:"Ok",Color:"Green"})+'<span style="color: darkgreen">'}return i+=t+"</span>",i}log(e){let t=GetId(this.ID),i="";0==this.CurrentLog&&(t.innerHTML=""),i+="<div>"+(new Date).toLocaleTimeString()+": "+EditorConsole.message(e.Gravity,e.Message)+"</div>",this.CurrentLog++,e.Reset?t.innerHTML=i:t.insertAdjacentHTML("beforeend",i),t.scrollTo({top:t.scrollHeight,behavior:"smooth"}),"Success"!=e.Gravity&&window.scrollTo({top:0,behavior:"smooth"}),this.CurrentLog>this.MaxLog&&t.children[0].remove()}reset(){GetId(this.ID).innerHTML=""}}class Definition{constructor(e,t){return this.Area=e,this.Input=t,this.Parser=t.Parser,this.Source=t.Source,this.Mapping=t.Mapping,this.Mapper=Mapper.new(t.Mapping),this.PlateIndex=LinkCtrl.new("Select",{ID:Definition.anchors("PlateIndex"),Default:0,List:[1],NavBar:!0,Lookup:!0,Label:"Plate",Title:"The plate that will be used for the display of definitions",Change:function(e){this.previewPlate(e)}.bind(this)}),this.PlatesID,this}static anchors(e){let t="Definition";switch(e){case"RangeTable":return t+"_RangeTable";case"PlateIndex":return t+"_PlateIndex";case"Preview":return t+"_Preview";default:return t}}static formEdit(e){var t=this.anchors("RangeTable"),i=this.anchors("Preview"),a=LinkCtrl.new("TextArea",{ID:i,Preserve:!0,Default:""}),n=function(e){a.setValue("Preparing preview, please wait...");let t=e.Definition;Mapper.scan(t,{Log:!0,Preview:{Column:Mapper.definition().Name}}).then((function(i){i.Error?e.Selected&&a.setValue(i.Error):(t.update(i),e.Selected&&(i.LimitReached&&(i.Preview+="\n... ("+(t.Items-i.Limit)+" items remaining)"),a.setValue(i.Preview))),s.update()}))},l=function(e,t,i){Mapper.map(t,{Validate:!0,BackToImport:i,Done:function(){e.Definition=new Definition(e,t[0]),n(e)},Parameters:[Mapper.definition(),Mapper.well(),Mapper.plate()]})},s=new RespTable({ID:t,Array:e,Fields:["Name","Other","DefInfo"],Headers:["Name","Properties","Definition"],Preserve:!0,RowNumbers:!0,NoControls:!0,onSelect:function(e){e.length>0&&n(e[0])}});let r="";r+='<div id="'+t+'" style="float: left; width:250px"><p><b>Ranges available:</b></p></div>',r+='<div style="margin-left: 270px">',r+="<p><b>Definition preview:</b></p>",r+='<div id="'+i+'"></div>',r+="</div>";var o="Form_DefinitionEdit";Form.open({ID:o,HTML:r,Title:"Definition management",Size:600,Buttons:[{Label:"Select file",Icon:{Type:"Load",Space:!0},Click:function(){var e=s.Selected;if(0!=e.length){var t=e[0];Form_Import.open({Single:!0,Chain:!0,OnClose:function(e){l(t,e,!0)}})}else alert("No range selected!")},Title:"Select or change the definition file for the selected Range"},{Label:"Edit Mapping",Icon:{Type:"Edit",Space:!0},Click:function(){var e=s.Selected;if(0!=e.length){var t=e[0];void 0!==t.Definition?l(t,[t.Definition.Input]):alert("No file selected!")}else alert("No range selected!")},Title:"Edit the column mapping for the definition file attached to the selected Range"},{Label:"Reset",Icon:{Type:"Reset",Space:!0},Click:function(){var e=s.Selected;if(0!=e.length){var t=e[0];t.removeDefinition(),s.update(),n(t)}else alert("No range selected!")},Title:"Remove the definition for the selected Range"},{Label:"Done",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){Pairing.updateAll(Editor.ResultManager.Anchors.Pairing),Form.close(o)},Title:"Close this form"}],onInit:function(){s.init(),a.init().disable();var e=s.Selected;e.length>0?n(e[0]):(s.setValue([0]),n(s.Selected[0]))}})}static formPlate(e){let t=Definition.anchors("RangeTable"),i=Definition.anchors("Preview"),a=Definition.anchors("PlateIndex"),n=function(e){let t=e.Definition;t?0==t.PlatesID.length?GetId(i).innerHTML="No wells tagged for this area":t.PlateIndex.init().change(t.PlateIndex.Value):GetId(i).innerHTML="No definition found for this range"}.bind(this),l=new RespTable({ID:t,Array:e,Fields:["Name","Other","DefInfo"],Headers:["Name","Properties","Definition"],Preserve:!0,RowNumbers:!0,NoControls:!0,onSelect:function(e){e.length>0&&n(e[0])}}),s="";s+='<div id="'+t+'" style="float: left; width: 250px">',s+='<div style="margin-top: 10px; margin-bottom: 20px"><b>Ranges available:</b></div>',s+="</div>",s+='<div style="margin-left: 270px">',s+='<div style="margin-top: 10px; margin-bottom: 10px"><b>Plate selected:</b>',s+='<div id="'+a+'" style="display: inline-block; margin-left: 10px"></div>',s+="</div>",s+="<b>Plate preview:</b>",s+='<div id="'+i+'" style="margin-top: 5px; overflow: auto"></div>',s+="</div>";var r="Form_PlateMap";Form.open({ID:r,HTML:s,Title:"Plate map",Size:800,Buttons:[{Label:"Printable version",Click:function(){Reporter.printable(GetId(i).innerHTML)},Title:"Open the map in a new window to allow easy printing or copy/pasting to other applications"},{Label:"Done",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){Pairing.update(Editor.ResultManager.Anchors.Pairing),Form.close(r)},Title:"Close this form"}],onInit:function(){l.init();var e=l.Selected;e.length>0?n(e[0]):(l.setValue([0]),n(l.Selected[0]))}.bind(this)})}static getAsPlate(e){let t=e.Area,i=t.MaxRange,a={Plate:e.PlateIndex.Selected,Factor:i,Default:"",AreaName:t.Name,Column:e.Mapping[Mapper.definition().Name],RangeIndexBase0:t.MaxRange,FindAll:!0};return new Promise((function(i){e.Mapper.find(e,a).then((function(a){let n=void 0;switch(Mapper.modeWellPlate(e.Mapping)){case"Plate":case"Direct":n=a=Area.plateDefinition(t,a);break;case"Well":case"PlateWell":n=Area.plateDefinition(t,Array(t.MaxRange).fill(1))}i({Definition:a,Tag:n})}))}))}update(e){if(e&&(this.Items=e.Items,e.PlatesID&&(this.PlatesID=e.PlatesID)),(void 0===this.PlatesID||"Direct"==Mapper.modeWellPlate(this.Mapping))&&(this.PlatesID=[],this.Area.MaxRange>0)){let e=Math.ceil(this.Items/this.Area.MaxRange);for(let t=0;t<e;t++)this.PlatesID.push(t+1)}return this.Area.DefInfo="Source: "+this.Source+"<br>"+this.Items+" items / "+this.PlatesID.length+" plates",this.PlateIndex.updateList(this.PlatesID).setValue(0),this}item(e){let t=this.PlateIndex.getValue(),i=Math.ceil(this.Area.Tagged/this.Area.Replicates),a=t*i+(e.RangeIndex-1),n={Plate:this.PlateIndex.Selected,Well:e.Index,RangeIndexBase0:e.RangeIndex-1,Factor:i,Default:"#"+(a+1),Column:this.Mapping[Mapper.definition().Name]};return this.Mapper.find(this,n)}previewPlate(e){let t=Definition.anchors("Preview"),i=this.PlateIndex.Selected;GetId(t).innerHTML='<span class="Error">Preparing preview, please wait...</span>',Definition.getAsPlate(this).then(function(e){let a=Editor.Plate.Rows,n=Editor.Plate.Cols,l=e.Definition,s=e.Tag,r='<table class="PlateTable"><tr><th></th>';for(let e=0;e<n;e++)r+="<th>"+(e+1)+"</th>";r+="</tr>";for(let e=0;e<a;e++){r+="<tr><th>"+Well.alphabet(e)+"</th>";for(let t=0;t<n;t++){let i="unset",a=l[e*n+t];s[e*n+t]?(i="lemonchiffon",0==a.length&&(a='<span class="Error">&Oslash;</span>')):a.length>0&&(a='<span class="Error">'+a+"</span>"),r+='<td style="background-color: '+i+'">'+a+"</td>"}r+="</tr>"}r+="</table>",i==this.PlateIndex.Selected&&(GetId(t).innerHTML=r)}.bind(this))}}class Editor{constructor(){}static init(){this.Root="Editor",this.pixelRatio=2;let e=this.Root+"_Menu",t=this.Root+"_Main",i=this.Root+"_Popup";this.Anchors={Menu:{Root:e,Areas:e+"Areas",AreaOptions:e+"AreaOptions",Results:e+"Results",Plate:e+"Plate",Layout:e+"Layout",Conc:e+"Concentration",DRC:e+"Conc_DRC",Analysis:e+"Analysis"},Main:{Root:t,Plate:t+"Plate",Results:t+"Results"},Popup:{Root:i,Well:i+"Well",Area:i+"Area",Conc:i+"Conc",Select:i+"Select",Data:i+"Data",ResolvedName:i+"ResolvedName"}};let a='<div id="'+this.Anchors.Popup.Well+'" style="font-weight: bold"></div>';a+='<div id="'+this.Anchors.Popup.Area+'"></div>',a+='<div id="'+this.Anchors.Popup.Conc+'"></div>',a+='<div id="'+this.Anchors.Popup.Select+'"></div>',a+='<div id="'+this.Anchors.Popup.Data+'"></div>',GetId(this.Anchors.Popup.Root).innerHTML=a,this.Menu=new TabControl({ID:this.Anchors.Menu.Root,Multiple:!0,Stack:!0,Layout:"Menu",Tabs:[{Label:"Plate",Active:!0,Content:{Type:"HTML",Value:'<fieldset><div id="'+this.Anchors.Menu.Plate+'"></div></fieldset><fieldset id="'+this.Anchors.Menu.Layout+'"><legend>Options</legend></fieldset>'}},{Label:"Areas",Content:{Type:"HTML",Value:'<fieldset></fieldset><fieldset id="'+this.Anchors.Menu.Areas+'"><legend>Areas available</legend></fieldset><fieldset id="'+this.Anchors.Menu.AreaOptions+'"><legend>Options</legend></fieldset>'}},{Label:"Concentration",Content:{Type:"HTML",Value:'<fieldset id="'+this.Anchors.Menu.Conc+'"></fieldset><fieldset id="'+this.Anchors.Menu.DRC+'"><legend>Dose-response</legend></fieldset>'}},{Label:"Results",Content:{Type:"HTML",Value:'<fieldset></fieldset><fieldset id="'+this.Anchors.Menu.Results+'"><legend>Results available</legend></fieldset>'}},{Label:"Analysis",Content:{Type:"HTML",Value:'<div id="'+this.Anchors.Menu.Analysis+'"></div>'}}]}),this.Main=new TabControl({ID:this.Anchors.Main.Root,Multiple:!0,Layout:"Menu",Tabs:[{Label:"Layout",Active:!0,Content:{Type:"HTML",Value:'<div id="'+this.Anchors.Main.Plate+'"><p>Choose a plate format or load a layout to start</p></div>'}},{Label:"Data",Content:{Type:"HTML",Value:'<div id="'+this.Anchors.Main.Results+'" style="position: relative"><p>Load a result file to continue</p></div>'}}]}),this.Tables={Areas:new RespTable({ID:this.Anchors.Menu.Areas,Fields:["Type","Name","Color","Other"],Preserve:!0,FullWidth:!0,RowNumbers:!0,onDelete:function(e){this.deleteArea(e)}.bind(this)}),Results:new RespTable({ID:this.Anchors.Menu.Results,Fields:["Name","Size","Info","Validated"],Headers:["Name","Size","Parameters","&check;"],Preserve:!0,FullWidth:!0,RowNumbers:!0,onDelete:function(e){this.deleteResult(e)}.bind(this),onSelect:function(e,t,i,a){t[0]&&i[0]==a[0]&&0!=e[0].Validated||this.ResultManager.draw(e[0])}.bind(this),onUpdate:function(){this.Report()}.bind(this)})},this.Controls={Plate:{Rows:LinkCtrl.new("Number",{ID:this.Anchors.Menu.Plate,Title:"Number of rows",Min:1,Max:48,Default:4,Label:"Rows",Chain:{Index:0}}),Cols:LinkCtrl.new("Number",{ID:this.Anchors.Menu.Plate,Title:"Number of columns",Min:1,Max:48,Default:6,Label:"Columns",Chain:{Index:1,Last:!0}})},Area:{Lock:LinkCtrl.new("Checkbox",{ID:this.Anchors.Menu.AreaOptions,Label:"Lock Areas",Default:!0,Preserve:!0,Chain:{Index:0},Change:function(){}.bind(this),Title:"If checked, prevent tagged areas from being replaced when tagged again"}),Strict:LinkCtrl.new("Checkbox",{ID:this.Anchors.Menu.AreaOptions,Label:"Strict Mode",Default:!0,Chain:{Index:1,Last:!0},Change:function(e){this.strictMode(e)}.bind(this),Title:"If checked, prevent areas with types 'Sample' or 'Range' to overlap with 'Controls'"})},Concentration:{Value:LinkCtrl.new("Number",{ID:this.Anchors.Menu.Conc,Title:"Value for the concentration",Min:0,Default:20,Label:"Value",Preserve:!0,Chain:{Index:0}}),Unit:LinkCtrl.new("Select",{ID:this.Anchors.Menu.Conc,Title:"Unit for the concentration",Default:2,Label:"Unit",ControlLeft:!0,Chain:{Index:1,Last:!0},List:Unit.list({Name:!0})}),Doses:LinkCtrl.new("Number",{ID:this.Anchors.Menu.DRC,Title:"Total number of doses in the dose-response curve",Min:0,Default:10,Label:"Doses",Preserve:!0,Chain:{Index:0}}),Rep:LinkCtrl.new("Number",{ID:this.Anchors.Menu.DRC,Title:"How many times the same dose should be replicated side-by-side",Min:0,Default:1,Label:"Replicates",ControlLeft:!0,Chain:{Index:1,Last:!0}}),Operator:LinkCtrl.new("Select",{ID:this.Anchors.Menu.DRC,Title:"Mathematical operator to use for calculation of the next dose",Chain:{Index:2,NewLine:!0},Default:0,Label:"Operator",List:["/","×","+","×10^"]}),Factor:LinkCtrl.new("Number",{ID:this.Anchors.Menu.DRC,Title:"Number to use with the operator for calculation of the next dose",Chain:{Index:3,Last:!0},Default:2,Label:"Factor",ControlLeft:!0}),Direction:LinkCtrl.new("Radio",{ID:this.Anchors.Menu.DRC,Label:"Direction",Title:"Direction of the dose-response",Default:0,Chain:{Index:4,NewLine:!0},List:["Horizontal","Vertical"]})},Result:{},Analysis:{}},this.Console=new EditorConsole("Console"),this.ResultManager=new ResultManager(this.Anchors.Main.Results,this.Tables.Results),this.Menu.init(),this.Main.init(),Object.values(this.Tables).forEach((function(e){e.init()})),Object.values(this.Controls).forEach((function(e){Object.values(e).forEach((function(e){e.init()}))})),GetId(this.Anchors.Menu.Plate).prepend(LinkCtrl.buttonBar([{Label:"96 wells",Title:"Create the layout for a 96-well plate (8 Rows × 12 Columns)",Click:function(){this.newPlate(8,12)}.bind(this)},{Label:"384 wells",Title:"Create the layout for a 384-well plate (16 Rows × 24 Columns)",Click:function(){this.newPlate(16,24)}.bind(this)},{Label:"1536 wells",Title:"Create the layout for a 1536-well plate (32 Rows × 48 Columns)",Click:function(){this.newPlate(32,48)}.bind(this)},{Label:"Custom",Title:"Create the layout for a plate with the number of Rows and Columns as specified",Click:function(){var e=this.Controls.Plate.Rows.getValue(),t=this.Controls.Plate.Cols.getValue();this.newPlate(e,t)}.bind(this)}])),GetId(this.Anchors.Menu.Layout).append(LinkCtrl.buttonBar([{Label:"Load",Title:"Load a layout from file",Icon:{Type:"Load",Space:!0},Click:function(){this.load()}.bind(this)},{Label:"Save",Title:"Save the current layout",Icon:{Type:"Save",Space:!0},Click:function(){this.save()}.bind(this)},{Label:"Reset",Title:"Reset the entire project: areas, tags, concentrations and results will be removed",Icon:{Type:"Reset",Space:!0},Click:function(){this.warn().then(function(){this.reset()}.bind(this),(function(){}))}.bind(this)}])),GetId(this.Anchors.Menu.Areas).previousSibling.append(LinkCtrl.buttonBar([{Label:"Definitions",Title:"Edit definitions for available ranges",Click:function(){this.definitions()}.bind(this)},{Label:"Edit",Title:"Edit the selected area",Icon:{Type:"Edit",Space:!0},Click:function(){this.editArea()}.bind(this)},{Label:"New",Title:"Create a new area",Icon:{Type:"New",Space:!0},Click:function(){this.newArea()}.bind(this)}])),GetId(this.Anchors.Menu.Areas).previousSibling.append(LinkCtrl.buttonBar([{Label:"Untag all",Title:"Remove tagged areas for the whole plate",Click:function(){this.untagAllArea()}.bind(this)},{Label:"Untag",Title:"Remove tagged areas from the selection",Click:function(){this.untagArea()}.bind(this)},{Label:"Tag",Title:"Tag the selected area in the selection",Icon:{Type:"Tag",Space:!0},Click:function(){this.tagArea()}.bind(this)}])),GetId(this.Anchors.Menu.Conc).prepend(LinkCtrl.buttonBar([{Label:"Reset",Title:"Reset Concentration data for the whole plate",Icon:{Type:"Reset",Space:!0},Click:function(){this.resetConc()}.bind(this)},{Label:"Untag",Title:"Untag all concentrations from the selection",Click:function(){this.untagConc()}.bind(this)},{Label:"Tag",Title:"Tag the defined concentration in the selection",Icon:{Type:"Tag",Space:!0},Click:function(){this.tagConc()}.bind(this)}]));var n=GetId(this.Anchors.Menu.DRC);return n.insertAdjacentHTML("beforeend","<br>"),n.append(LinkCtrl.button({Label:"Tag DRC",Title:"Tag the defined dose-response in the selection",Icon:{Type:"Tag",Space:!0},Click:function(){this.tagDRC()}.bind(this)})),GetId(this.Anchors.Menu.Results).previousSibling.append(LinkCtrl.buttonBar([{Label:"Add results",Icon:{Type:"New",Space:!0},Title:"Attach new results file to the plate layout",Click:function(){this.newResult()}.bind(this)},{Label:"Edit",Title:"Edit the selected result",Icon:{Type:"Edit",Space:!0},Click:function(){this.editResult()}.bind(this)},{Label:"Pairing",Title:"Tools for pairing of result and definition plates",Click:function(){this.pairing()}.bind(this)}])),GetId(this.Anchors.Menu.Results).previousSibling.append(LinkCtrl.buttonBar([{Label:"Push Layout",Title:"Push the layout data to the selected result file",Click:function(){this.pushLayout()}.bind(this)}])),GetId(this.Anchors.Menu.Analysis).prepend(LinkCtrl.buttonBar([{Label:"Controls",Title:"Aggregate data for the controls defined in the layout and compute Z-factors",Click:function(){this.Report("zFactor")}.bind(this)},{Label:"Column Analysis",Title:"Compute statistics for the combinations of all areas and concentrations defined in the layout, organized as individual columns",Click:function(){this.Report("aggregate")}.bind(this)},{Label:"Grouped Analysis",Title:"Compute statistics for the combinations of all areas and concentrations defined in the layout, organized as two-entry tables",Click:function(){this.Report("grouped")}.bind(this)}])),this}static warn(e,t){if(void 0===this.Plate&&0==this.Tables.Areas.Array.length&&0==this.Tables.Results.Array.length)return Promise.resolve();if(t&&t.Silent)return Promise.resolve();let i="Form_Warning",a="This will reset the entire project.<br>All tags, areas, definitions and results will be discarded.",n="Reset layout";switch(e){case"tag":a="This will remove all tags for all layers on the plate.",n="Reset tags";break;case"conc":a="This will remove all concentration data for all layers on the plate.",n="Reset concentrations"}return new Promise((function(e,t){Form.open({ID:i,HTML:'<div style="text-align: center"><p>'+a+'</p><p class="Error">Are you sure you want to continue ?</p></div>',Title:n,Buttons:[{Label:"Reset",Click:function(){Form.close(i),e()}},{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(i),t()}}]})}))}static reset(){this.Plate=void 0,this.Main.init(),Object.values(this.Tables).forEach((function(e){e.empty()})),this.Console.log({Message:"Project reset",Gravity:"Success",Reset:!0})}static newPlate(e,t){if(this.Plate)if(this.Plate.Rows!=e||this.Plate.Cols!=t){let i="Form_Resize",a=i+"_RadioArea",n=i+"_RadioConc",l=LinkCtrl.new("Radio",{ID:a,Default:0,Preserve:!0,List:["Keep","Discard"],Title:"Keep will maintain area tagging data for the wells still available in the new plate"}),s=LinkCtrl.new("Radio",{ID:n,Default:0,Preserve:!0,List:["Keep","Discard"],Title:"Keep will maintain concentration values for the wells still available in the new plate"}),r='<div style="text-align: center"><p>This will resize your plate to the new dimensions.<br>Select what should be done with previously entered data:</p></div>';r+='<fieldset id="'+a+'"><legend>Area data</legend></fieldset>',r+='<fieldset id="'+n+'"><legend>Concentration data</legend></fieldset>',r+='<div class="Error" style="text-align: center"><p>Data for wells outside the new plate dimensions will be discarded</p></div>',Form.open({ID:i,HTML:r,Title:"Resize plate",Buttons:[{Label:"Resize",Click:function(){this.resize(e,t,l.Selected,s.Selected),Form.close(i)}.bind(this)},{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(i)}}],onInit:function(){l.init(),s.init()}})}else this.Console.log({Message:"No changes in plate dimensions",Gravity:"Warning"});else this.Plate=new Plate(this.Anchors.Main.Plate,e,t),this.Plate.init(),this.Menu.closeAll().jumpTo(1);return this}static resize(e,t,i,a){return"Discard"==i?this.untagAllArea({Silent:!0}):e<=this.Plate.Rows&&t<=this.Plate.Cols&&(Area.resize(this.Tables.Areas.Array,this.Plate,e,t),this.Tables.Areas.update()),"Discard"==a&&this.resetConc({Silent:!0}),Plate.resize(this.Plate,e,t),this.Console.log({Message:"Plate dimensions changed",Gravity:"Success",Reset:!0}),this}static save(){let e="[";e+=Plate.save(this.Plate)+",";let t="[",i=!1;return this.Tables.Areas.Array.forEach((function(e,a){a>0&&(t+=","),t+=Area.save(e),i=!0})),e+=t+"]]",0==i&&void 0===this.Plate?(this.Console.log({Message:"Nothing to save",Gravity:"Warning"}),this):(Form.download(e,{DataType:"text/json;charset=utf-8",FileName:"Layout.save"}),this)}static load(){let e="Form_Load",t=LinkCtrl.new("File",{ID:"FormLoad_FileSelect",Default:"",Label:"Layout file",Title:"Click to select the file containing the layout definition",Accept:".save"});return Form.open({ID:e,HTML:'<p>Select the Layout file to load</p><div id="'+t.ID+'"></div>',Title:"Load layout",Buttons:[{Label:"Next",Click:function(){let i=t.getValue();if(0==i.length)return alert("No file selected"),this;let a=new FileReader;a.onload=function(e){this.loadPreview(e.target.result)}.bind(this),a.readAsText(i[0]),Form.close(e)}.bind(this)},{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(e)}}],onInit:function(){t.init()}}),this}static loadPreview(e){let t=void 0;try{t=JSON.parse(e)}catch(e){return this.Console.log({Message:"Unable to load the layout. <i>"+e+"</i>",Gravity:"Error"}),this}let i=t[0],a=t[1],n="Form_LoadPreview",l=n+"_Plate",s=n+"_Areas";Form.open({ID:n,HTML:'<fieldset id="'+l+'"><legend>Plate data</legend></fieldset><fieldset id="'+s+'"><legend>Areas data</legend></fieldset>',Title:"Layout preview",Buttons:[{Label:"Load",Click:function(){this.warn().then(function(){this.reset(),this.loadData(i,a),Form.close(n)}.bind(this),(function(){}))}.bind(this)},{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(n)}}],onInit:function(){Area.loadPreview(a,s),Plate.loadPreview(i,l)}})}static loadData(e,t){return e&&(this.newPlate(e.Rows,e.Cols),Plate.load(this.Plate,e)),t&&t.length>0&&(Area.load(this.Tables.Areas,t,this.Plate,e),this.Tables.Areas.update()),this.Plate.update(),this.Menu.closeAll().jumpTo(1),this.Console.log({Message:"Layout successfully loaded",Gravity:"Success",Reset:!0}),this}static newArea(){var e="Form_NewArea";return Area.form({ID:e,Color:CSSCOLORS.fetch(this.Tables.Areas.Length),Ok:function(t,i){this.addArea(t,i)&&Form.close(e)}.bind(this),Another:function(e,t){this.addArea(e,t)&&(e.Name.setValue("").focus(),e.Color.setValue(CSSCOLORS.fetch(this.Tables.Areas.Length)))}.bind(this)}),this}static addArea(e,t){let i=e.Name.getValue();if(0==i.length)return alert("Area name must be at least 1 character"),!1;if(this.Tables.Areas.hasElement("Name",i))return alert("This name has already been defined, please choose another one"),!1;let a=e.Color.getValue(),n=e.Type.Selected;if("Range"==n){let e=t.Replicates.getValue();if(e<1||e>1536)return alert("Replicates for range must be a valid integer between 1 and 1536"),!1;let l=t.Direction.Selected,s=t.Priority.Selected,r=t.Custom.getValue();return this.Tables.Areas.addRow(new Area({Name:i,Color:a,Type:n,Replicates:e,Direction:l,Priority:s,Custom:r})),!0}return this.Tables.Areas.addRow(new Area({Name:i,Color:a,Type:n})),!0}static editArea(){var e=this.Tables.Areas.Selected;if(0==e.length)return this.Console.log({Message:"No area selected",Gravity:"Error"}),this;var t="Form_EditArea",i=e[0];return Area.form({ID:t,Edit:!0,Area:i,Color:i.Color,Ok:function(e,a){let n=e.Name.getValue();i.Name!=n&&this.Tables.Areas.hasElement("Name",n)?alert("This name has already been defined, please choose another one"):0!=n.length?(Pairing.rename(i.Name,n),i.Name=n,i.Color=e.Color.getValue(),"Range"==i.Type&&(i.Replicates=a.Replicates.getValue(),i.Direction=a.Direction.Selected,i.Priority=a.Priority.Selected,i.Custom=a.Custom.getValue(),Area.rangeInfo(i)),this.Plate&&i.update(this.Plate.WellSize,this.Plate.WellMargin),this.Tables.Areas.update(),Pairing.update(this.ResultManager.Anchors.Pairing),Form.close(t)):alert("Area name must be at least 1 character")}.bind(this)}),this}static tagArea(){if(void 0===this.Plate)return this;var e=this.Tables.Areas.Selected;if(0==e.length)return this.Console.log({Message:"No area selected",Gravity:"Error"}),this;var t=this.Controls.Area.Lock.getValue(),i=this.Controls.Area.Strict.getValue();return Plate.tagArea(this.Plate,e[0],{Lock:t,Strict:i}).then(function(t){return t.Cancel?this:0==t.Selected?(this.Console.log({Message:"No wells selected",Gravity:"Error"}),this):("Range"==e[0].Type&&this.Plate.updateRange(e[0]),t.Tagged<t.Selected?(0==t.Tagged?this.Console.log({Message:"None of the selected wells ("+t.Selected+") were tagged",Gravity:"Error"}):this.Console.log({Message:"Only "+t.Tagged+" selected wells (out of "+t.Selected+") were tagged",Gravity:"Warning"}),this):(t.Tagged==t.Selected&&this.Console.log({Message:t.Tagged+" wells tagged",Gravity:"Success"}),void this.Tables.Areas.update()))}.bind(this)),this}static untagArea(){if(void 0===this.Plate)return this;let e=this.Plate.untag();return 0==e.Untag?(this.Console.log({Message:"No wells selected",Gravity:"Error"}),this):(this.Tables.Areas.update(),this.Console.log({Message:e.Untag+" wells untagged",Gravity:"Success"}),this)}static untagAllArea(e){if(void 0===this.Plate)return this;let t=this.Tables.Areas,i=this.Plate;return t.Length>0?this.warn("tag",e).then(function(){t.Array.forEach((function(e){e.removeTags(i),e.Tags=[],"Range"==e.Type&&(e.MaxRange=0,Area.rangeInfo(e))})),t.update(),this.Console.log({Message:"All wells untagged",Gravity:"Success"})}.bind(this),(function(){})):this.Console.log({Message:"No area defined",Gravity:"Warning"}),this}static deleteArea(e){return this.Plate&&e.removeTags(this.Plate),this}static strictMode(e){if(void 0===this.Plate)return this;if(e){let e=TypeMap.getConflicts(this.Plate.TypeMap);e.length>0&&(this.Controls.Area.Strict.setValue(!1),this.Plate.highlightConflicts(e),this.Console.log({Message:"Conflicts detected! Must be resolved before activating strict mode",Gravity:"Error"}))}return this}static definitions(){let e=Area.getRanges();return 0==e.length?(this.Console.log({Message:"No ranges defined",Gravity:"Error"}),this):(Definition.formEdit(e),this)}static tagConc(){if(void 0===this.Plate)return this;let e=this.Plate.tagConc(this.Controls.Concentration.Value.getValue(),this.Controls.Concentration.Unit.Selected);return 0==e?(this.Console.log({Message:"No wells selected",Gravity:"Error"}),this):(this.Console.log({Message:"Concentration added in "+e+" wells",Gravity:"Success"}),this)}static untagConc(){if(void 0===this.Plate)return this;let e=this.Plate.untagConc();return 0==e?(this.Console.log({Message:"No wells selected",Gravity:"Error"}),this):(this.Console.log({Message:"Concentration removed in "+e+" wells",Gravity:"Success"}),this)}static resetConc(e){if(void 0===this.Plate)return this;this.warn("conc",e).then(function(){this.Plate.resetConc()}.bind(this),(function(){}))}static tagDRC(){if(void 0===this.Plate)return this;let e=this.Controls.Concentration,t=e.Operator.Selected;t=t.replace("×","*"),t=t.replace("^","**");let i={Value:e.Value.getValue(),Unit:e.Unit.Selected,Doses:e.Doses.getValue(),Rep:e.Rep.getValue(),Operator:t,Factor:e.Factor.getValue(),Direction:e.Direction.Selected},a=this.Plate.tagDRC(i);return 0==a?(this.Console.log({Message:"No wells selected",Gravity:"Error"}),this):(this.Console.log({Message:"DRC added in "+a+" wells",Gravity:"Success"}),this)}static newResult(){return Form_Import.open({Chain:!0,OnClose:function(e){let t=[];e.forEach(function(e){t.push(new Result(e))}.bind(this)),this.ResultManager.mapParameters(t,!0),this.Main.jumpTo(1)}.bind(this)}),this}static editResult(){return this.ResultManager.mapParameters(),this}static deleteResult(e){return this.ResultManager.deleteResult(e),this}static pushLayout(){let e=this.Tables.Results.Selected;return this.Plate?e.length>0?this.ResultManager.pushLayout(e[0]):this.Console.log({Message:"No result file selected",Gravity:"Error"}):this.Console.log({Message:"No plate defined",Gravity:"Error"}),this}static pairing(){let e=Area.getRanges({HasDefinition:!0}),t=this.Tables.Results.Array.filter((function(e){return!!e.Validated&&(e["Plate Count"]=e.PlatesID.length,!0)}));return 0==e.length||0==t.length?(this.Console.log({Message:"At least one definition and one validated result files are required for pairing",Gravity:"Error"}),this):(Pairing.form(t,e),this)}static Report(e){let t=this.Tables.Results.Array.filter((function(e){return e.Validated}));if(window.Results=t,void 0===e)return this;if(void 0===this.Plate)return this.Console.log({Message:"No plate defined",Gravity:"Error"}),this;if(0==t.length)return this.Console.log({Message:"No result file available",Gravity:"Error"}),this;switch(e){case"zFactor":return this.zFactor();case"aggregate":return this.aggregate();case"grouped":return this.grouped()}}static zFactor(){let e=Area.getControls(this.Tables.Areas.Array);return 0==e.Count?(this.Console.log({Message:"No controls defined in the current layout",Gravity:"Error"}),this):(Reporter.zFactor(e),this)}static aggregate(){let e=Area.getAreas(this.Tables.Areas.Array);return 0==e.Count?(this.Console.log({Message:"No areas defined in the current layout",Gravity:"Error"}),this):(Reporter.aggregate(e),this)}static grouped(){let e=Area.getAreas(this.Tables.Areas.Array);if(0==e.Count)return this.Console.log({Message:"No areas defined in the current layout",Gravity:"Error"}),this;let t=this.Plate.getConc();return Reporter.grouped(e,t),this}}class Layer{constructor(e){let t=e.Rows,i=e.Cols;this.Plate=e.Plate,this.Rows=t,this.Cols=i,this.Index=e.Layer,this.Wells=[],this.Highlight=void 0,this.Contents=void 0,this.Grid=void 0,this.Selected=void 0,this.Root="Layer_"+e.Layer;let a=0;for(let e=0;e<t;e++)for(let t=0;t<i;t++)this.Wells.push(new Well({Index:a,Row:e,Col:t,Layer:this})),a++;return this}static rootHTML(e,t){return"<fieldset><legend>Layer "+(e+1)+' &bull; </legend><div id="'+t+'" style="position: relative;"></div></fieldset>'}static exportControls(e){let t=LinkCtrl.buttonBar([Layer.getAsJPGControl(e),Layer.getAsHTMLControl(e)],!0);t.style.fontWeight="normal",t.style.fontSize="0.7em",GetId(e.Root).previousSibling.append(t)}static getAsJPGControl(e){return{Label:"jpg",Title:"Click here to view this layer as a .jpg image file",Click:function(){let t=document.createElement("canvas");t.height=e.Grid.height,t.width=e.Grid.width;let i=t.getContext("2d");i.fillStyle="white",i.fillRect(0,0,t.width,t.height),i.drawImage(e.Grid,0,0),i.drawImage(e.Contents,0,0);let a=t.toDataURL("image/jpeg");Reporter.printable("<p><b>Layer "+(e.Index+1)+'</b></p><img src="'+a+'"></img>')}}}static getAsHTMLControl(e){return{Label:"html",Title:"Click here to view this layer as an html array",Click:function(){let t="Form_GetAsHTML",i=t+"_Controls",a=t+"_Output",n=Layer.getAsHTML(e);Form.open({ID:t,HTML:'<div id="'+i+'" style="margin: 10px"><p class="Error">Resolving names, please wait...</p></div><div id='+a+' style="max-height: 500px; overflow: auto"><p><b>Layer '+(e.Index+1)+"</b></p>"+n.HTML+"</div>",Size:700,Title:"Layer as HTML",Buttons:[{Label:"Printable Version",Click:function(){Reporter.printable(GetId(a).innerHTML)},Title:"Display the layer in a new window to allow easy printing or copy/pasting to other applications"},{Label:"Close",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(t)}}]}),Promise.all(n.Promises).then((function(t){if(0==t.length)return void GetId(i).remove();let n=e.Rows,l=e.Cols,s=GetId(a).children[1];for(let e=0;e<n;e++)for(let i=0;i<l;i++){let a=s.rows[e+1].cells[i+1].children[2];if(a&&a.hasAttributes("resolved")){let n=!1;t.forEach((function(t){let s=t.Definition[e*l+i];""!=s&&(a.setAttribute("resolved",s),n=!0)})),0==n&&a.setAttribute("resolved",a.getAttribute("generic"))}}LinkCtrl.new("Checkbox",{ID:i,Label:"Show resolved Names",Default:!1,Change:function(e){let t=GetId(a).getElementsByClassName("Resolved_Definition"),i=t.length;for(let a=0;a<i;a++)t[a].innerHTML=e?t[a].getAttribute("resolved"):t[a].getAttribute("generic")},Title:"Tick to show the resolved names instead of the generic names for the ranges"}).init()}))}}}static getAsHTML(e){let t=e.Rows,i=e.Cols,a=[],n='<table style="text-align: center; "><tr><th></th>';for(let e=0;e<i;e++)n+="<th>"+(e+1)+"</th>";n+="</tr>";for(let l=0;l<t;l++){n+="<tr><th>"+Well.alphabet(l)+"</th>";for(let t=0;t<i;t++){let s=e.Wells[l*i+t],r=s.Area,o="white",h="black",c="";r&&(o=r.Color,h=CSSCOLORS.font(r.Color),c='<span style="font-weight: bold; border: 1px solid black; padding: 0em 0.1em; margin-right: 0.2em">'+TypeMap.symbolForValue(TypeMap.valueForType(r.Type))+"</span>"+r.Name,"Range"==r.Type&&(c+="&nbsp;(#"+s.RangeIndex+')<br><span style="font-style: italic; padding:0.1em" class="Resolved_Definition" resolved="" generic="#'+s.RangeIndex+'">#'+s.RangeIndex+"</span>",void 0===a.find((function(e){return e.Name==r.Name}))&&a.push(r))),n+='<td style="background-color:'+o+"; color: "+h+'; padding: 0.2em; border: 1px solid black">'+c+"<br>"+Well.dose(s)+"</td>"}n+="</tr>"}n+="</table>";let l=[];return a.forEach((function(e){e.Definition&&l.push(Definition.getAsPlate(e.Definition))})),{HTML:n,Promises:l}}static save(e){let t=[];return e.Wells.forEach((function(e){e.Conc&&t.push(Well.save(e))})),t}static load(e,t,i,a,n){t.forEach((function(t){let a=e.Wells[t.Index];a&&a.tagConc({Value:t.Value,Unit:t.Unit,Digit:i})}))}static resize(e,t,i){let a=e.Rows,n=e.Cols,l=[];var s=0;let r=0;for(;r<t;){let t=0;for(;t<i;){if(t<n&&r<a){let i=e.Wells[n*r+t];i.Index=s,l.push(i)}else l.push(new Well({Index:s,Row:r,Col:t,Layer:e}));s++,t++}r++}e.Wells=l,e.Rows=t,e.Cols=i}static getCoords(e){if(e.clientX)return{clientX:e.clientX,clientY:e.clientY,layerX:e.layerX,layerY:e.layerY};e.preventDefault();let t=e.targetTouches;return 0==e.targetTouches.length&&(t=e.changedTouches),{clientX:t[0].clientX,clientY:t[0].clientY,layerX:t[0].clientX-e.target.getBoundingClientRect().x,layerY:t[0].clientY-e.target.getBoundingClientRect().y}}init(){let e="";e+='<canvas style="position: absolute;"></canvas>',e+='<canvas style="position: absolute;"></canvas>',e+='<canvas style="position: absolute;"></canvas>';let t=GetId(this.Root);return t.innerHTML='<canvas style="position: absolute;"></canvas><canvas style="position: absolute;"></canvas><canvas style="position: absolute;"></canvas>',Layer.exportControls(this),this.Highlight=t.children[0],this.Grid=t.children[1],this.Contents=t.children[2],this.bindEvents(t),this}bindEvents(e){let t=this.Plate,i=void 0,a=function(e){if(void 0!==e.button&&0!=e.button)return;if(void 0!==e.touches&&e.touches.length>1)return;let i=Layer.getCoords(e),a=t.wellAtPointer(i,this);0==e.ctrlKey&&0==t.Options.AddToSel.getValue()&&t.resetSelection(),t.select(e,i,{Start:a})}.bind(this),n=function(e){let i=Layer.getCoords(e),a=t.wellAtPointer(i,this);t.select(e,i,{Stop:!0,Layer:this.Index,Well:a})}.bind(this),l=function(e){t.highlight(),i&&clearTimeout(i),t.infoPopup()}.bind(this),s=function(e){if("CANVAS"!=e.target.nodeName)return;let a=Layer.getCoords(e),n=t.wellAtPointer(a,this),l=GetId(Editor.Anchors.Popup.Root);l.style.left=a.clientX+10+"px",l.style.top=a.clientY-40+"px",(t.Highlighting&&t.Highlighting.Index!=n.Index||void 0===t.Highlighting)&&(t.highlight(e,n),i&&(clearTimeout(i),t.infoPopup()),i=setTimeout(t.infoPopup.bind(t),500,e,n)),0==e.buttons?t.select(void 0,a,{Stop:!0}):t.Selecting&&t.select(e,a,{Move:n})}.bind(this);return e.addEventListener("touchstart",a,{passive:!1}),e.addEventListener("mousedown",a),e.addEventListener("touchend",(function(e){n(e),l(e)})),e.addEventListener("mouseup",n),e.addEventListener("touchmove",s,{passive:!1}),e.addEventListener("mousemove",s),e.addEventListener("mouseout",l),e.addEventListener("wheel",l,{passive:!0}),this}grid(e){let t=e.height,i=e.width,a=Editor.pixelRatio;[this.Grid,this.Highlight,this.Contents].forEach((function(e){e.height=t,e.width=i,e.style.height=t/a+"px",e.style.width=i/a+"px"}));let n=GetId(this.Root);return n.style.width=e.width/a+"px",n.style.height=e.height/a+"px",this.Grid.getContext("2d").drawImage(e,0,0),this}highlight(e){let t=this.Highlight,i=t.getContext("2d");return i.clearRect(0,0,t.width,t.height),e.length>0&&e.forEach((function(e){i.drawImage(e.Image,e.x,e.y)})),this}select(e,t,i){let a=this.Contents.getContext("2d");return a.setTransform(Editor.pixelRatio,0,0,Editor.pixelRatio,0,0),e.forEach((function(e){e&&(e.Selected=!0,e.content(a,t,i))})),this.Selected=this.Wells.filter((function(e){return e.Selected})),this}unselect(e,t){if(this.Selected){let i=this.Contents.getContext("2d");this.Selected.forEach((function(a){a.Selected=!1,a.content(i,e,t)})),this.Selected=void 0}return this}content(e,t){let i=this.Contents,a=i.getContext("2d");return a.clearRect(0,0,i.width,i.height),a.font=5*Math.floor(t/2)+"px arial",a.setTransform(Editor.pixelRatio,0,0,Editor.pixelRatio,0,0),this.Wells.forEach((function(i){i.content(a,e,t)})),this}setIndex(e){this.Index=e,GetId(this.Root).previousSibling.innerHTML="Layer "+(e+1)}tagArea(e,t){let i=t.Results;if(this.Selected){t.Layer=this;let a=this.Contents.getContext("2d"),n=t.Size,l=t.Margin;this.Selected.forEach((function(s){s.tag(e,t),0==s.Duplicate&&0==s.Error?(Area.log(e,this,s),i.Tagged++,("Range"!=e.Type||"Range"==e.Type&&e.Custom)&&s.content(a,n,l)):(s.Error||"Range"!=e.Type||"Range"==e.Type&&e.Custom)&&s.content(a,n,l),i.Selected++}),this),0==t.Keep&&(this.Selected=void 0)}return this}untag(e){let t=e.Results;if(this.Selected){e.Layer=this;let i=this.Contents.getContext("2d"),a=e.Size,n=e.Margin;this.Selected.forEach((function(l){l.untag(e),l.content(i,a,n),t.Untag++})),0==e.Keep&&(this.Selected=void 0)}return this}highlightConflicts(e,t,i){this.Contents.getContext("2d");let a=this.Wells,n=[];return e.forEach((function(e){a[e].Error=!0,n.push(a[e])})),this.select(n,t,i),this}tagConc(e){if(this.Selected){let t=this.Contents.getContext("2d"),i=e.Size,a=e.Margin;this.Selected.forEach((function(n){n.tagConc(e),n.content(t,i,a),e.Selected++})),0==e.Keep&&(this.Selected=void 0)}return this}untagConc(e){if(this.Selected){let t=this.Contents.getContext("2d"),i=e.Size,a=e.Margin;this.Selected.forEach((function(n){n.untagConc(),n.content(t,i,a),e.Selected++})),0==e.Keep&&(this.Selected=void 0)}return this}resetConc(e){let t=this.Contents.getContext("2d"),i=e.Size,a=e.Margin;return this.Wells.forEach((function(e){e.untagConc(),e.content(t,i,a)})),this}concMap(e){let t=this.Rows,i=this.Cols,a='<table class="PlateTable"><tr><th></th>';for(let e=0;e<i;e++)a+="<th>"+(e+1)+"</th>";let n=Math.log10(this.Wells.reduce((function(e,t){return t.Value?Math.min(e,t.Value):e}),1/0)),l=Math.log10(this.Wells.reduce((function(e,t){return t.Value?Math.max(e,t.Value):e}),-1/0)),s=[[150,150,255],[255,255,255],[255,150,150]];a+="</tr>";for(let e=0;e<t;e++){a+="<tr><th>"+Well.alphabet(e)+"</th>";for(let t=0;t<i;t++){let r=this.Wells[e*i+t];a+='<td style="background-color:'+CSSCOLORS.heatmap(Math.log10(r.Value),n,l,s)+'">'+Well.dose(r)+"</td>"}a+="</tr>"}return a+="</table>",GetId(e).nextElementSibling.innerHTML=a,this}tagDRC(I){let S=this.Selected;if(S){let ctx=this.Contents.getContext("2d"),size=I.Size,margin=I.Margin;"Horizontal"==I.Direction?S.sort((function(e,t){return e.Index-t.Index})):S.sort((function(e,t){return e.Col-t.Col||e.Row-t.Row}));let rep=0,value=I.Value,dose=0;S.forEach((function(w){w.tagConc(I),w.content(ctx,size,margin),rep++,rep==I.Rep&&(rep=0,dose++,dose==I.Doses?(I.Value=value,dose=0):I.Value=eval(I.Value+I.Operator+I.Factor)),I.Selected++}))}return this}changeDigit(e,t,i){let a=this.Contents.getContext("2d");return this.Wells.forEach((function(n){n.Conc&&(n.changeDigit(e),n.content(a,t,i))})),this}}class Parameter{constructor(e,t){return this.ID=void 0,this.Name=e,this.Unit=t||"",this.Selected=!1,this.Numeric=void 0,this.GlobalMin=1/0,this.GlobalMax=-1/0,this.Grid=document.createElement("canvas"),this.Highlight=document.createElement("canvas"),[this.Grid,this.Highlight].forEach((function(e){e.style.position="absolute"})),this}static getMinMax(e,t,i){let a=e.GlobalMin,n=e.GlobalMax;return i&&(i.Local?(a=t.reduce((function(e,t){return isNaN(t)?e:Math.min(e,t)}),1/0),n=t.reduce((function(e,t){return isNaN(t)?e:Math.max(e,t)}),-1/0)):(a=i.Min,n=i.Max)),{Min:a,Max:n}}resize(e){let t=e.Grid.width,i=e.Grid.height,a=Editor.pixelRatio;return[this.Grid,this.Highlight].forEach((function(e){e.width=t,e.height=i,e.style.width=t/a+"px",e.style.height=i/a+"px"})),this}grid(e){let t=e.WellSize,i=t+e.WellMargin,a=this.Grid.getContext("2d");a.drawImage(e.Grid,0,0),a.setTransform(Editor.pixelRatio,0,0,Editor.pixelRatio,0,0),a.lineWidth=2,a.strokeStyle="red";let n=e.Rows,l=e.Cols;for(let e=0;e<n;e++)for(let n=0;n<l;n++){let l=(n+1)*i,s=(e+1)*i;a.beginPath(),a.moveTo(l+.2*t,s+.2*t),a.lineTo(l+.8*t,s+.8*t),a.moveTo(l+.8*t,s+.2*t),a.lineTo(l+.2*t,s+.8*t),a.stroke()}return this}heatmap(e,t,i,a,n,l){if(void 0===e||isNaN(e))return this;let s=this.Grid.getContext("2d"),r=i.WellSize,o=r+i.WellMargin,h=Math.floor(t/i.Cols),c=t-h*i.Cols;return s.fillStyle=CSSCOLORS.heatmap(e,n,l,a),s.fillRect((c+1)*o,(h+1)*o,r,r),this}txt(e,t,i){if(void 0===e)return this;let a=this.Grid.getContext("2d"),n=i.WellSize,l=i.WellMargin,s=n+l,r=Math.floor(t/i.Cols),o=(t-r*i.Cols+1)*s,h=(r+1)*s;return a.fillStyle="white",a.fillRect(o,h,n,n),a.fillStyle="black",a.font=2*Math.floor(l/2)+3+"px arial",a.textAlign="center",a.textBaseline="middle",a.fillText(e,o+.5*n,h+.5*n,n),this}draw(e,t){let i=GetId(this.ID),a=Editor.pixelRatio;i.innerHTML="",i.style.width=this.Grid.width/a+"px",i.style.height=this.Grid.height/a+"px",i.appendChild(this.Highlight),i.appendChild(this.Grid);let n=Editor.Plate,l=void 0;return i.addEventListener("mousemove",function(i){if("CANVAS"!=i.target.nodeName)return;let a=Editor.ResultManager.LayerSelect.Selected-1,s=n.wellAtPointer(i,n.Layers[a]),r=GetId(Editor.Anchors.Popup.Root);r.style.left=i.clientX+10+"px",r.style.top=i.clientY-40+"px",(n.Highlighting&&n.Highlighting.Index!=s.Index||void 0===n.Highlighting)&&(n.highlight(i,s),l&&(clearTimeout(l),n.infoPopup()),l=setTimeout(n.infoPopup.bind(n),500,i,s,{Result:e,Parameter:t}))}.bind(this)),i.addEventListener("mouseout",function(e){n.highlight(),l&&clearTimeout(l),n.infoPopup()}.bind(this)),i.addEventListener("wheel",function(e){n.highlight(),l&&clearTimeout(l),n.infoPopup()}.bind(this),{passive:!0}),this}highlight(e){let t=this.Highlight,i=t.getContext("2d");return i.clearRect(0,0,t.width,t.height),e.length>0&&e.forEach((function(e){i.drawImage(e.Image,e.x,e.y)})),this}}class Plate{constructor(e,t,i){return this.Rows=t,this.Cols=i,this.Root=e,this.WellSize=20,this.WellMargin=5,this.Highlighting=void 0,this.Selecting=void 0,this.Anchors={Options:e+"_Options",Selection:e+"_Selection",LayerTab:e+"_LayerTab",LayerSelect:e+"_LayerSelect"},this.Options={KeepSelected:LinkCtrl.new("Checkbox",{ID:this.Anchors.Options,Title:"If checked, the selection will remain active after a tag (area or concentration)",Default:!0,Label:"Keep selection",Chain:{Index:0}}),Digits:LinkCtrl.new("Select",{ID:this.Anchors.Options,Title:"Number of digits to show for the concentrations",Label:"Digits",Default:1,List:[2,3,4,5,6,"All"],Chain:{Index:1,Last:!0},Change:function(e){this.digit()}.bind(this)}),AddToSel:LinkCtrl.new("Checkbox",{ID:this.Anchors.Selection,Default:!1,Label:"Multiple",Title:"If turned on, selected wells will be added to the current selection. If you have a keyboard, keep the Ctrl key pressed down while selecting to obtain the same effect."})},this.Controls={LayerSelect:LinkCtrl.new("Select",{ID:this.Anchors.LayerSelect,Default:0,Label:"Layer",List:[1],NavBar:!0,Change:function(e){this.Layers[e].concMap(this.Anchors.LayerSelect)}.bind(this),Title:"Select the layer to use for display"})},this.TypeMap=new TypeMap(this),this.Grid=document.createElement("canvas"),this.Highlight=document.createElement("canvas"),this.Header=document.createElement("canvas"),this.Layers=[new Layer({Rows:t,Cols:i,Layer:0,Plate:this})],this.LastKey=1,this.LayerTab=new TabControl({ID:this.Anchors.LayerTab,Multiple:!0,Tabs:[{Label:"Layer 1",Active:!0,Controls:["Delete"],Content:{Type:"HTML",Value:Layer.rootHTML(0,this.Layers[0].Root)}}],AfterDelete:function(e){this.deleteLayer(e)}.bind(this)}),this}static styleCtx(e,t){switch(e.setTransform(Editor.pixelRatio,0,0,Editor.pixelRatio,0,0),t){case"grid":e.lineWidth=2,e.strokeStyle="dimgray",e.textAlign="center",e.textBaseline="middle";break;case"highlight":e.strokeStyle="gold",e.lineWidth=2,e.shadowColor="goldenrod",e.shadowBlur=5;break;case"header":e.fillStyle="pink",e.shadowColor="pink";break;case"selectBox":e.strokeStyle="blue",e.fillStyle="gray",e.globalAlpha=.4,e.setLineDash([1,2]);break;case"selecting":e.fillStyle="gold"}}static save(e){if(void 0===e)return"null";let t=[];return e.Layers.forEach((function(e){t.push(Layer.save(e))})),JSON.stringify({Rows:e.Rows,Cols:e.Cols,KeepSelected:e.Options.KeepSelected.getValue(),Digits:e.Options.Digits.getValue(),Layers:t})}static loadPreview(e,t){let i="";e?(i+="Rows: <b>"+e.Rows+"</b>; ",i+="Cols: <b>"+e.Cols+"</b><br>",i+="Layers: <b>"+e.Layers.length+"</b>"):i='<p class="Error">No data</p>',GetId(t).insertAdjacentHTML("beforeend",i)}static load(e,t){e.Options.KeepSelected.setValue(t.KeepSelected),e.Options.Digits.setValue(t.Digits),t.Layers.forEach((function(t,i){i>0&&e.addLayer(),Layer.load(e.Layers[i],t,e.Options.Digits.Selected,e.WellSize,e.WellMargin)}))}static resize(e,t,i){e.Options.Digits.Selected;e.Layers.forEach((function(e,a){Layer.resize(e,t,i)})),e.TypeMap.resize(t,i),e.Rows=t,e.Cols=i,e.update();let a=Editor.Tables.Results;a.Array.forEach((function(e){e.Validated=!1})),a.update();let n=a.Selected;n.length>0&&Editor.ResultManager.draw(n[0],{NoPrompt:!0})}static tagArea(e,t,i){return i.Keep=e.Options.KeepSelected.getValue(),i.Size=e.WellSize,i.Margin=e.WellMargin,i.Map=e.TypeMap,i.Results={Tagged:0,Selected:0,Ranges:[]},new Promise((function(a){if("Range"==t.Type&&t.Custom){let n="Form_CustomRange",l=n+"_RangeIndex",s=LinkCtrl.new("Number",{ID:l,Default:t.MaxRange+1,Min:1,Label:"Range index",Title:"Indicate here the numbering that should be applied to the tagged wells"});Form.open({ID:n,HTML:'<div id="'+l+'"></div>',Title:"Custom numbering",Buttons:[{Label:"Ok",Click:function(){i.RangeIndex=s.getValue(),a(e.tagArea(t,i)),Form.close(n)}},{Label:"Cancel",Click:function(){i.Cancel=!0,a(i),Form.close(n)}}],onInit:function(){s.init()}})}else a(e.tagArea(t,i))}))}init(){let e=GetId(this.Root),t="";t+='<div style="overflow: auto">',t+='<fieldset style="float: left"><legend>Selection</legend><div id="'+this.Anchors.Selection+'"></div></fieldset>',t+='<fieldset style="float: left"><legend>Zoom</legend></fieldset>',t+='<fieldset style="float: left"><legend>Options</legend><div id="'+this.Anchors.Options+'"></div></fieldset>',t+='<fieldset style="float: left"><legend>Views</legend></fieldset>',t+="</div>",t+='<div id="'+this.Anchors.LayerTab+'" style="margin-top: 10px"></div>',e.innerHTML=t,this.LayerTab.init(),this.Layers[0].init(),Object.values(this.Options).forEach((function(e){e.init()}));let i=LinkCtrl.buttonBar([{Label:"Add layer",Title:"Add a new layer to the plate",Click:function(){this.addLayer()}.bind(this)}],!0),a=GetId(this.Anchors.Options);a.insertAdjacentHTML("beforeend","&nbsp;"),a.append(i);let n=LinkCtrl.buttonBar([{Label:"",Title:"Zoom in on the layout, each well will be bigger",Icon:{Type:"ZoomIn"},Click:function(){this.zoom(1)}.bind(this)},{Label:"",Title:"Zoom out on the layout, each well will be smaller",Icon:{Type:"ZoomOut"},Click:function(){this.zoom(-1)}.bind(this)}]);e.children[0].children[1].append(n);let l=LinkCtrl.buttonBar([{Label:"Types",Title:"Display a map showing the type of area defined for each well",Click:function(){this.typeMap()}.bind(this)},{Label:"Plates",Title:"Display a form to navigate between the different plates available for the definitions",Click:function(){this.plateMap()}.bind(this)},{Label:"Conc.",Title:"Display a map showing the concentrations defined for each well, per layer",Click:function(){this.concMap()}.bind(this)}]);e.children[0].children[3].append(l);let s=LinkCtrl.buttonBar([{Label:"Clear",Title:"Unselect all wells for all layers",Click:function(){this.resetSelection()}.bind(this)}],!0);return a=GetId(this.Anchors.Selection),a.insertAdjacentHTML("beforeend","&nbsp;"),a.append(s),this.grid(),this}addLayer(){let e=this.LastKey++,t=this.Layers,i=t.length,a=new Layer({Rows:this.Rows,Cols:this.Cols,Layer:e,Plate:this});return t.push(a),this.LayerTab.addTab({Label:"Layer "+(i+1),SetActive:!0,Controls:["Delete"],Content:{Type:"HTML",Value:Layer.rootHTML(i,a.Root)}}),a.init().grid(this.Grid),Editor.ResultManager.layerUpdate(),this}deleteLayer(e){this.Layers.splice(e,1);var t=this.LayerTab;return this.Layers.forEach((function(i,a){a>e-1&&(i.setIndex(a),t.rename(a,"Layer "+(a+1)))})),Editor.ResultManager.layerUpdate(),this}wellAtPointer(e,t){let i=this.WellMargin,a=this.WellSize+i,n=a-.5*i,l=Math.floor((e.layerX-n)/a),s=Math.floor((e.layerY-n)/a);return l>-1&&s>-1&&s<this.Rows&&l<this.Cols?t.Wells[s*this.Cols+l]:{Col:l,Row:s,Layer:t,Index:s*this.Cols+l,Header:!0}}zoom(e){var t=!1;if(e<0?this.WellSize>10&&(this.WellSize-=10,this.WellMargin-=2,t=!0):this.WellSize<70&&(this.WellSize+=10,this.WellMargin+=2,t=!0),t){this.update();let e=Editor.Tables.Results.Selected;e.length>0&&1==e[0].Validated&&Editor.ResultManager.draw(e[0])}}update(){var e=this.WellSize,t=this.WellMargin;return this.grid(),this.Selecting&&this.select(void 0,void 0,{Stop:!0}),this.Layers.forEach((function(i){i.content(e,t)}),this),this}grid(){let e=this.WellSize,t=this.WellMargin,i=this.Cols,a=this.Rows,n=e+t,l=this.Grid;Editor.pixelRatio;l.width=(i+1)*n*Editor.pixelRatio,l.height=(a+1)*n*Editor.pixelRatio;let s=l.getContext("2d");Plate.styleCtx(s,"grid"),s.font="bold "+(5*Math.floor(t/2)+5)+"px arial";for(let t=0;t<i;t++){let i=(t+1)*n;for(let l=0;l<a;l++){let a=(l+1)*n;s.strokeRect(i,a,e,e),0==t&&s.fillText(Well.alphabet(l),n/2,a+e/2)}s.fillText(t+1,i+e/2,n/2)}return this.Layers.forEach((function(e){e.grid(l)})),this.header(),this}drawHighlight(e){let t=[];if(e){let i=this.Highlight,a=this.WellSize,n=this.WellMargin,l=a+n,s=i.getContext("2d"),r=Editor.pixelRatio;if(e.Row>=this.Rows||e.Col>=this.Cols)return this;if(e.Row<0)if(e.Col<0){let e=this.Grid.height,o=this.Grid.width;i.width=o,i.height=e,Plate.styleCtx(s,"highlight"),s.strokeRect(l-2,l-2,o/r-a-2*n+4,e/r-a-2*n+4),t.push({Image:i,x:0,y:0}),t.push({Image:this.Header,x:n/2,y:n/2})}else{let o=this.Grid.height;i.width=(a+20)*r,i.height=o,Plate.styleCtx(s,"highlight"),s.strokeRect(8,l-2,a+4,o/r-a-2*n+4),t.push({Image:i,x:((e.Col+1)*l-10)*r,y:0})}else if(e.Col<0){let o=this.Grid.width;i.height=(a+20)*r,i.width=o,Plate.styleCtx(s,"highlight"),s.strokeRect(l-2,8,o/r-a-2*n+4,a+4),t.push({Image:i,x:0,y:((e.Row+1)*l-10)*r})}else i.width=(a+20)*r,i.height=(a+20)*r,Plate.styleCtx(s,"highlight"),s.strokeRect(8,8,a+4,a+4),t.push({Image:i,x:(e.x(l)-10)*r,y:(e.y(l)-10)*r});e.Col>-1&&t.push({Image:this.Header,x:(e.Col+1)*l*r,y:n/2}),e.Row>-1&&t.push({Image:this.Header,x:n/2,y:(e.Row+1)*l*r})}return t}highlight(e,t){this.Highlighting=t;let i=this.drawHighlight(t);return this.Layers.forEach((function(e){e.highlight(i)})),Editor.ResultManager.highlight(i),this}header(){let e=this.WellMargin,t=this.WellSize,i=this.Header;i.width=t*Editor.pixelRatio,i.height=t*Editor.pixelRatio;let a=i.getContext("2d");return Plate.styleCtx(a,"header"),a.arc(t/2,t/2,5*Math.floor(e/2),0,2*Math.PI),a.fill(),this}select(e,t,i){return i.Start&&this.startSelection(e,t,i.Start),i.Stop&&(this.Selecting&&(void 0!==i.Layer&&this.Layers[i.Layer].select(this.Selecting.Includes,this.WellSize,this.WellMargin),this.Selecting.Box.remove(),this.Selecting.Select.remove(),this.Selecting=void 0),GetId(Editor.Anchors.Popup.Select).innerHTML="",GetId(Editor.Anchors.Popup.Area).innerHTML.length+GetId(Editor.Anchors.Popup.Conc).innerHTML.length==0&&this.infoPopup()),i.Move&&this.moveSelection(e,t,i.Move),this}resetSelection(){let e=this.WellSize,t=this.WellMargin;return this.Layers.forEach((function(i){i.unselect(e,t)})),this}startSelection(e,t,i){let a=document.createElement("canvas"),n=this.Grid.width;a.width=n,a.height=this.Grid.height,a.style.position="absolute",a.style.left=0,a.style.top=0,a.style.zIndex=10,a.style.width=n/Editor.pixelRatio+"px";let l=a.cloneNode();l.style.zIndex=-1,l.style.width=n/Editor.pixelRatio+"px",Plate.styleCtx(a.getContext("2d"),"selectBox");let s=l.getContext("2d");Plate.styleCtx(s,"selecting"),e.target.parentElement.append(a),e.target.parentElement.append(l),this.Selecting={Start:i,Box:a,Select:l,x:t.layerX,y:t.layerY,LastVisited:i,Includes:[i]},this.drawWellsInLasso(s,i)}moveSelection(e,t,i){var a=this.Selecting.x,n=this.Selecting.y,l=this.Selecting.Box;if((s=l.getContext("2d")).clearRect(0,0,l.width,l.height),s.fillRect(a,n,t.layerX-a,t.layerY-n),s.strokeRect(a,n,t.layerX-a,t.layerY-n),i.Index!=this.Selecting.LastVisited.Index){var s,r=this.Selecting.Select;(s=r.getContext("2d")).clearRect(0,0,r.width,r.height),this.drawWellsInLasso(s,i),this.Selecting.LastVisited=i}}drawWellsInLasso(e,t){var i=this.WellSize,a=this.WellMargin,n=this.Selecting.Start;this.Selecting.Includes=[];var l=Math.min(n.Row,t.Row),s=Math.min(n.Col,t.Col),r=Math.abs(n.Row-t.Row)+1,o=Math.abs(n.Col-t.Col)+1;let h="R <b>";-1==l?(r=this.Rows+1,h+=this.Rows):h+=r,h+=" &times; ",-1==s?(o=this.Cols+1,h+=this.Cols):h+=o,GetId(Editor.Anchors.Popup.Select).innerHTML=h+"</b> C";var c=s+o,d=l+r,u=(i+a)*(s+1),p=(i+a)*(l+1),g=this.Layers[t.Layer.Index];for(let t=s;t<c;t++){for(let n=l;n<d;n++)n==l&&(p=(i+a)*(l+1)),t>-1&&n>-1&&this.Selecting.Includes.push(g.Wells[t+n*this.Cols]),e.fillRect(u-3,p-3,i+6,i+6),p+=i+a;u+=i+a}}infoPopup(e,t,i){let a=Editor.Anchors.Popup,n=GetId(a.Root);if(void 0===e)return n.style.display="none",this;let l=!1;t.Header?GetId(a.Well).innerHTML="":(GetId(a.Well).innerHTML=Well.alphabet(t.Row)+(t.Col+1),l=!0);let s=t.Area;return s?(GetId(a.Area).innerHTML='<span class="Boxed">'+TypeMap.symbolForValue(TypeMap.valueForType(s.Type))+"</span>"+s.Name+' <span id="'+a.ResolvedName+'"></span>',l=!0):GetId(a.Area).innerHTML="",t.Conc?(GetId(a.Conc).innerHTML=Well.dose(t,this.Options.Digits.getValue()),l=!0):GetId(a.Conc).innerHTML="",i?(GetId(a.Data).innerHTML="Resolving value...",i.Result.getValue(i.Parameter,t).then(function(e){GetId(a.Data).innerHTML=e||""}.bind(this))):GetId(a.Data).innerHTML="",0==l&&void 0===this.Selecting?(n.style.display="none",this):(n.style.display="block",s&&"Range"==s.Type&&(GetId(a.ResolvedName).innerHTML="(Resolving name...)",Area.fetchRangeItem(s,t).then(function(e){this.Highlighting&&this.Highlighting.Area&&this.Highlighting.Area.Name==s.Name&&this.Highlighting.RangeIndex==t.RangeIndex&&(GetId(a.ResolvedName).innerHTML="("+e+")")}.bind(this))),this)}typeMap(){let e="TypeMap",t=this.TypeMap.draw();return Form.open({ID:e,HTML:'<div style="overflow: auto;margin-right: 5px">'+t+"</div>",Title:"Type map",Size:700,Buttons:[{Label:"Printable version",Click:function(){Reporter.printable(t)}.bind(this),Title:"Open the map in a new window to allow easy printing or copy/pasting to other applications"},{Label:"Close",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(e)}}]}),this}plateMap(){let e=Area.getRanges();return 0==e.length?(Editor.Console.log({Message:"No ranges defined",Gravity:"Error"}),this):(Definition.formPlate(e),this)}concMap(){if(0==this.Layers.length)return this;return Form.open({ID:"ConMap",HTML:'<div id="'+this.Anchors.LayerSelect+'" style="margin-bottom: 10px"></div><div style="overflow: auto;"></div>',Title:"Concentration map",Size:700,Buttons:[{Label:"Printable version",Click:function(){Reporter.printable(GetId(this.Anchors.LayerSelect).nextSibling.innerHTML)}.bind(this),Title:"Open the map in a new window to allow easy printing or copy/pasting to other applications"},{Label:"Close",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close("ConMap")}}],onInit:function(){let e=this.Controls.LayerSelect,t=this.Layers.length,i=[];for(let e=0;e<t;e++)i.push(e+1);e.List=i,e.init().change(e.Value)}.bind(this)}),this}tagArea(e,t){return this.Layers.forEach((function(i){i.tagArea(e,t)})),t.Results.Ranges.forEach((function(e){this.updateRange(e)}),this),t.Results}updateRange(e){return e.updateRange(this.WellSize,this.WellMargin),this}untag(){let e={Keep:this.Options.KeepSelected.getValue(),Size:this.WellSize,Margin:this.WellMargin,Map:this.TypeMap,Results:{Untag:0,Ranges:[]}};return this.Layers.forEach((function(t){t.untag(e)})),e.Results.Ranges.forEach((function(e){this.updateRange(e)}),this),e.Results}highlightConflicts(e){let t=this.WellSize,i=this.WellMargin;return this.Layers.forEach((function(a){a.highlightConflicts(e,t,i)})),this}tagConc(e,t){let i={Value:e,Digit:this.Options.Digits.Selected,Unit:t,Selected:0,Size:this.WellSize,Margin:this.WellMargin,Keep:this.Options.KeepSelected.getValue()};return this.Layers.forEach((function(e){e.tagConc(i)})),i.Selected}untagConc(){var e={Selected:0,Size:this.WellSize,Margin:this.WellMargin,Keep:this.Options.KeepSelected.getValue()};return this.Layers.forEach((function(t){t.untagConc(e)})),e.Selected}resetConc(){var e={Size:this.WellSize,Margin:this.WellMargin};return this.Layers.forEach((function(t){t.resetConc(e)})),this}tagDRC(e){return e.Size=this.WellSize,e.Margin=this.WellMargin,e.Keep=this.Options.KeepSelected.getValue(),e.Digit=this.Options.Digits.Selected,e.Selected=0,this.Layers.forEach((function(t){t.tagDRC(e)})),e.Selected}digit(){let e=this.Options.Digits.Selected,t=this.WellSize,i=this.WellMargin;return this.Layers.forEach((function(a){a.changeDigit(e,t,i)})),this}getConc(){let e=[];return this.Layers.forEach((function(t){t.Wells.forEach((function(t){if(t.Value){let i=e.find((function(e){return e.Unit==t.Unit}));if(i){let e=i.Values.find((function(e){return e.Value==t.Value}));e?e.Tags.push(t.Index):i.Values.push({Value:t.Value,Type:"Conc",Name:t.Unit,Tags:[t.Index]})}else e.push({Unit:t.Unit,Name:t.Unit,Values:[{Value:t.Value,Type:"Conc",Name:t.Unit,Tags:[t.Index]}]})}}))})),e}}class Result{constructor(e){return this.Input=e.Input,this.Name=e.Name,this.Size=e.Parser.SelectedRows+" rows",this.Parser=e.Parser,this.Mapper=void 0,this.Mapping=void 0,this.ParamSelected=0,this.PlatesID=[],this.Parameters=[],e.Headers.forEach((function(e,t){this.Parameters.push(new Parameter(e))}),this),this.Validated=!1,this.Info="",Result.updateParameters(this),this}static selected(e,t){e.ParamSelected=t,e.Info=e.Parameters.length+" available,<br>"+t+" selected"}static updateParameters(e){let t=0;if(e.Mapping){let i=e.Mapping[Mapper.import().Name],a=e.Mapping[Mapper.numeric().Name];e.Parameters.forEach((function(e,n){i&&(e.Selected=i[n],e.Selected&&t++),a&&(e.Numeric=a[n])}))}this.selected(e,t)}static updateMapping(e){let t=0,i=e.Mapping[Mapper.import().Name];e.Parameters.forEach((function(e,a){i[a]=e.Selected,e.Selected&&t++})),this.selected(e,t)}static getAsJPGControl(e,t){let i=e.Parameters[t],a=Editor.ResultManager.PlateSelect.Selected;return{Label:"jpg",Title:"Click here to view this heatmap as a .jpg image file",Click:function(){let t=document.createElement("canvas");t.height=i.Grid.height,t.width=i.Grid.width;let n=t.getContext("2d");n.fillStyle="white",n.fillRect(0,0,t.width,t.height),n.drawImage(i.Grid,0,0);let l=t.toDataURL("image/jpeg");Reporter.printable("<p><b>"+e.Name+" (Plate: "+a+") - "+i.Name+'</b></p><img src="'+l+'"></img>')}}}static getAsHTMLControl(e,t){let i=e.Parameters[t];return{Label:"html",Title:"Click here to view this heatmap as an html array",Click:function(){let a="Form_GetAsHTML",n=a+"_Output",l=Editor.ResultManager.PlateSelect.Selected;Form.open({ID:a,HTML:'<div style="max-height: 500px; overflow: auto"><p><b>'+e.Name+" (Plate: "+l+") - "+i.Name+"</b></p><div id="+n+'><span class="Error">Resolving values, please wait...</span></div></div>',Size:700,Title:"Parameter as HTML",Buttons:[{Label:"Printable Version",Click:function(){Reporter.printable(GetId(n).parentElement.innerHTML)},Title:"Display the table in a new window to allow easy printing or copy/pasting to other applications"},{Label:"Close",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(a)}}]}),e.getValues(l,t).then((function(e){i.Numeric&&(e=Result.cleanValues(e));let t=Parameter.getMinMax(i,e,Editor.ResultManager.extremumObject()),a=Editor.ResultManager.gradColors(),l=Editor.Plate.Rows,s=Editor.Plate.Cols,r='<table style="text-align: center"><tr><th></th>';for(let e=0;e<s;e++)r+="<th>"+(e+1)+"</th>";r+="</tr>";for(let i=0;i<l;i++){r+="<tr><th>"+Well.alphabet(i)+"</th>";for(let n=0;n<s;n++){let l=e[i*s+n],o="rgb(255, 255, 255)";void 0===l?l='<span class="Error">&Oslash;</span>':o=CSSCOLORS.heatmap(l,t.Min,t.Max,a),r+='<td style="background-color:'+o+"; color: "+CSSCOLORS.font(o,"RGB_Unnamed")+'; padding: 0.2em; border: 1px solid black">'+l+"</td>"}r+="</tr>"}r+="</table>",GetId(n).innerHTML=r}))}}}static cleanValues(e){return e.map((function(e){return Mapper.cleanValue(e)}))}draw(e,t,i,a){let n=Editor.Plate;return this.Parameters.forEach((function(l,s){l.Selected&&(l.resize(n),l.grid(n),this.getValues(e,s).then(function(e){if(l.Numeric){e=Result.cleanValues(e);let i=Parameter.getMinMax(l,e,a);e.forEach((function(e,a){l.heatmap(e,a,n,t,i.Min,i.Max)}))}else e.forEach((function(e,t){l.txt(e,t,n)}));l.draw(this,s),i.style.height="unset"}.bind(this)))}),this),this}getValues(e,t){let i={Plate:e,Column:t,FindAll:!0};return this.Mapper.find(this,i)}getValue(e,t){let i={Plate:Editor.ResultManager.PlateSelect.Selected,Well:t.Index,Default:"",Column:e};return this.Mapper.find(this,i)}pushLayout(e){let t=!1,i=this.Mapping[Mapper.well().Name],a=Editor.Plate,n=[this.Parser.Headers.concat(["Area","Value","Unit"])];return new Promise(function(l){let s=Area.getRanges({HasDefinition:!0}),r=[];s.forEach((function(e){r.push(Definition.getAsPlate(e.Definition))})),Promise.all(r).then(function(r){let o={};s.forEach((function(e,t){o[e.Name]=r[t].Definition})),this.Parser.stream(function(l,s,r){let h=Well.parseIndex(l[i],a);void 0!==h&&(a.Layers.forEach((function(e){let t=e.Wells[h.Index];l=l.concat(Well.layoutData(t,o))})),n.push(l),n.length==e&&(t=!0,r.abort()))}.bind(this),(function(){l({Aborted:t,Data:n})}))}.bind(this))}.bind(this))}}class ResultManager{constructor(e,t){this.Results=t,this.Anchors={Root:e,Map_ResultTable:e+"_ResultTable",Map_Parameters:e+"_Parameters",ResultTab:e+"_ResultTab",Heatmap:e+"_Heatmap",HeatmapOptions:e+"_HeatmapOptions",Extremums:e+"_Extremums",ExtremumSource:e+"_ExtremumSource",PlateSelect:e+"_PlateSelect",LayerSelect:e+"_LayerSelect",Pairing:e+"_Pairing"},this.ResultTab=void 0;let i=function(e){this.draw(this.Results.Selected[0])}.bind(this);return this.PlateSelect=LinkCtrl.new("Select",{ID:this.Anchors.PlateSelect,Title:"Select the plate to use for display",Default:0,Label:"Plate",List:[1],NavBar:!0,Lookup:!0,Change:i}),this.LayerSelect=LinkCtrl.new("Select",{ID:this.Anchors.LayerSelect,Title:"Select the layer that will be used to display information in the tooltip",Default:0,NavBar:!0,Label:"Layer",List:[1]}),this.HeatmapOptions={Low:LinkCtrl.new("Color",{ID:this.Anchors.HeatmapOptions,Title:"Color for the lowest value",Default:"lightblue",Label:"0",Chain:{Index:0},Change:i}),Medium:LinkCtrl.new("Color",{ID:this.Anchors.HeatmapOptions,Title:"Color for the average value",Default:"white",Label:"50",Chain:{Index:1},Change:i}),High:LinkCtrl.new("Color",{ID:this.Anchors.HeatmapOptions,Title:"Color for the highest value",Default:"tomato",Label:"100",Chain:{Index:2,Last:!0},Change:i})},this.ExtremumSource=LinkCtrl.new("Select",{ID:this.Anchors.ExtremumSource,Default:0,Label:"Source",List:["Global","Plate","Custom"],Change:function(e){this.extremum(e)}.bind(this),Title:"Source of the min and max values to build the heatmap. Global: use parameter min/max values from the entire file; Plate: use parameter min/max values from the selected plate only; Custom: manually entered min and max values (applies to all parameters)"}),this.Extremums={Min:LinkCtrl.new("Number",{ID:this.Anchors.Extremums,Default:0,Label:"Min",Chain:{Index:0},Title:"Custom value for the minimum"}),Max:LinkCtrl.new("Number",{ID:this.Anchors.Extremums,Default:0,Label:"Max",Chain:{Index:1,Last:!0},Title:"Custom value for the maximum"})},this}init(){let e="";e+='<div style="overflow: auto">',e+='<fieldset style="float: left"><legend>Plate view</legend><div id="'+this.Anchors.PlateSelect+'"></div></fieldset>',e+='<fieldset style="float: left"><legend>Pairing</legend><div id="'+this.Anchors.Pairing+'"></div></fieldset>',e+='<fieldset style="float: left"><legend>Linked Layer</legend><div id="'+this.Anchors.LayerSelect+'"></div></fieldset>',e+='<fieldset style="float: left"><legend>Heatmap</legend><div id="'+this.Anchors.HeatmapOptions+'"></div></fieldset>',e+='<fieldset style="float: left"><legend>Min & Max</legend>',e+='<div id="'+this.Anchors.ExtremumSource+'" style="float: left"></div>',e+='<div id="'+this.Anchors.Extremums+'" style="float: left; display: none; margin-left: 5px"></div>',e+="</fieldset>",e+="</div>",e+='<div id="'+this.Anchors.ResultTab+'" class="LinkCtrl_Tab LinkCtrl_Round" style="margin-top: 10px; padding-left: 10px;"><p>Click on a result file to display heatmaps for selected parameters</p></div>',GetId(this.Anchors.Root).innerHTML=e,this.PlateSelect.init(),this.LayerSelect.init(),this.ExtremumSource.init(),Editor.Plate&&this.layerUpdate(),Object.values(this.HeatmapOptions).forEach((function(e){e.init()})),Object.values(this.Extremums).forEach((function(e){e.init()}));let t=LinkCtrl.button({Label:"Update",Title:"Click to redraw the heatmaps with the current custom values",Click:function(){let e=this.Results.Selected[0];this.draw(e)}.bind(this)}),i=GetId(this.Anchors.Extremums);i.insertAdjacentHTML("beforeend","&nbsp;"),i.append(t);let a=LinkCtrl.button({Label:"More...",Title:"Click here to select templates and see more options for heatmap colors",Click:function(){this.heatmapTemplates()}.bind(this)}),n=GetId(this.Anchors.HeatmapOptions);return n.insertAdjacentHTML("beforeend","&nbsp;"),n.append(a),this}layerUpdate(){let e=[],t=Editor.Plate.Layers.length;for(let i=0;i<t;i++)e.push(i+1);return this.LayerSelect.updateList(e),this}extremum(e){if(2==e)GetId(this.Anchors.Extremums).style.display="block";else{GetId(this.Anchors.Extremums).style.display="none";let e=this.Results.Selected[0];this.draw(e)}return this}addResults(e){let t=this.Results,i=t.Array.length;return 0==i&&this.init(),t.Array=t.Array.concat(e),t.setValue([i]),this}mapParameters(e,t){let i=!0;if(void 0===e&&(e=this.Results.Array,i=!1),0==e.length)return this;Mapper.map(e,{Validate:!0,BackToImport:t,Done:function(){i&&this.addResults(e),e.forEach((function(e){e.Mapper=Mapper.new(e.Mapping),Result.updateParameters(e)})),this.Results.update(),this.draw(this.Results.Selected[0])}.bind(this),OnChange:function(e){e.Validated=!1,Result.updateParameters(e),this.Results.update()}.bind(this),Parameters:[Mapper.well({Required:!0}),Mapper.plate(),Mapper.import(),Mapper.numeric()]})}draw(e,t){let i=GetId(this.Anchors.ResultTab);if(0==e.Validated)return i.innerHTML='<p class="Error" style="text-align: center">Result file not validated</p>',void 0===t&&this.validate(e),this;i.style.height=i.clientHeight+"px";this.PlateSelect.updateList(e.PlatesID);let a=this.PlateSelect.getValue();Pairing.resize(e),Pairing.setLinkedPlate(e,a,this.Anchors.Pairing),this.ResultTab=new TabControl({ID:this.Anchors.ResultTab,Multiple:!0,Tabs:[],AfterDelete:function(e){this.deleteParam(e)}.bind(this)});let n=0;this.ResultTab.init(),e.Parameters.forEach((function(t,i){if(t.Selected){t.ID=this.Anchors.Heatmap+"_"+n,this.ResultTab.addTab({Label:t.Name,SetActive:!0,Controls:["Delete"],Content:{Type:"HTML",Value:"<fieldset><legend>"+t.Name+' &bull; </legend><div id="'+t.ID+'" style="position: relative"><span class="Error">Preparing preview, please wait...</span></div></fieldset>'}});let a=LinkCtrl.buttonBar([Result.getAsJPGControl(e,i),Result.getAsHTMLControl(e,i)],!0);a.style.fontWeight="normal",a.style.fontSize="0.7em",GetId(t.ID).previousSibling.append(a),n++}}),this);let l=this.PlateSelect.Selected;return e.draw(l,this.gradColors(),i,this.extremumObject()),this}extremumObject(){switch(this.ExtremumSource.Selected){case"Global":return;case"Plate":return{Local:!0};case"Custom":return{Min:this.Extremums.Min.getValue(),Max:this.Extremums.Max.getValue()}}}gradColors(){return[CSSCOLORS.fetchRGB(this.HeatmapOptions.Low.getValue()),CSSCOLORS.fetchRGB(this.HeatmapOptions.Medium.getValue()),CSSCOLORS.fetchRGB(this.HeatmapOptions.High.getValue())]}validate(e){let t="Form_ValidateResult",i=t+"_Output",a=t+"_LineCount";Form.open({ID:t,HTML:'<div id="Form_ValidateResult_Output"><p class="Error">Validating file, please wait...</p><p style="display:none">Rows processed: <span id="Form_ValidateResult_LineCount">0</span></p></div>',Title:"Data validation",Buttons:[{Label:"Back to mapping",Icon:{Type:"Back",Space:!0},Click:function(){this.mapParameters(),Form.close(t)}.bind(this)},{Label:"Done",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){Form.close(t),e.Validated&&this.draw(e)}.bind(this)}]}),void 0!==Editor.Plate?(GetId(i).children[1].style.display="block",Mapper.scan(e,{Log:!0,MinMax:!0,Custom:function(e){let t=e.Items;500*Math.round(t/500)-t==0&&GetId(a)&&(GetId(a).innerHTML=t)}}).then(function(t){let n="";t.Items>0?(e.Validated=!0,e.PlatesID=t.PlatesID,n+='<p class="Success" style="text-align: center">Validation successful!</p>',n+="<ul><li>Valid wells: "+t.Items+"</li>",n+="<li>Plates found: "+t.PlatesID.length+"</li></ul>"):(e.Validated=!1,e.PlatesID=[],n+="No valid well data found"),GetId(a)&&(GetId(a).innerHTML=t.Items),GetId(i)&&(GetId(i).innerHTML=n),Result.updateParameters(e),this.Results.update()}.bind(this))):GetId(i).children[0].innerHTML="No plate defined, cannot validate the well data now"}highlight(e){let t=this.Results.Selected;return 0==t.length||t[0].Parameters.forEach((function(t){t.Selected&&t.highlight(e)})),this}deleteParam(e){let t=this.Results.Selected[0];return t.Parameters.filter((function(e){return e.Selected}))[e].Selected=!1,Result.updateMapping(t),this.Results.update(),this}deleteResult(e){return this.Results.Array.length>1?this.init():GetId(Editor.Anchors.Main.Results).innerHTML="<p>Load a result file to continue</p>",this}heatmapTemplates(){let e="Form_HeatmapTemplate",t=e+"_Colors",i=e+"_Template",a={Low:LinkCtrl.new("Color",{ID:t,Title:"Color for the lowest value",Default:this.HeatmapOptions.Low.getValue(),Label:"0",Chain:{Index:0}}),Medium:LinkCtrl.new("Color",{ID:t,Title:"Color for the average value",Default:this.HeatmapOptions.Medium.getValue(),Label:"50",Chain:{Index:1}}),High:LinkCtrl.new("Color",{ID:t,Title:"Color for the highest value",Default:this.HeatmapOptions.High.getValue(),Label:"100",Chain:{Index:2,Last:!0}})},n=CSSCOLORS.HMtemplates(),l="";l+='<div style="float: left; text-align: center">',l+="<p><b>Selected colors:</b></p>",l+='<div id="'+t+'"></div>',l+="</div>",l+='<div style="margin-left:200px">',l+="<p><b>Templates:</b></p>",l+='<div id="'+i+'" style="overflow: auto">',n.forEach((function(e,t){l+='<label class="LinkCtrl LinkCtrl_Round LinkCtrl_Resting" style="margin: 5px" name="'+t+'" title="Click on the template to apply its colors">',e.forEach((function(e){l+='<span style="background-color: '+e+'; border: 1px solid black; margin-right: 2px">&nbsp;&nbsp;&nbsp;&nbsp;</span>'})),l+="</label>",t%2==1&&(l+="<br>")})),l+="</div>",l+="</div>",Form.open({ID:e,HTML:l,Title:"Heatmaps",Buttons:[{Label:"Done",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){this.HeatmapOptions.Low.setValue(a.Low.getValue()),this.HeatmapOptions.Medium.setValue(a.Medium.getValue()),this.HeatmapOptions.High.setValue(a.High.getValue()),this.draw(this.Results.Selected[0]),Form.close(e)}.bind(this)},{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(e)}}],onInit:function(){Object.values(a).forEach((function(e){e.init()})),GetId(i).addEventListener("click",(function(e){let t=e.target;switch(t.nodeName){case"SPAN":t=t.parentElement;break;case"LABEL":break;default:return}let i=Number(t.attributes.name.value);a.Low.setValue(n[i][0]),a.Medium.setValue(n[i][1]),a.High.setValue(n[i][2])}));let e=LinkCtrl.button({Label:"Invert",Title:"Click here to invert the color gradient",Click:function(){let e=a.Low.getValue(),t=a.High.getValue();a.Low.setValue(t),a.High.setValue(e)}}),l=GetId(t);l.insertAdjacentHTML("beforeend","<br><br>"),l.append(e)}})}pushLayout(e){if(0==e.Validated)return Editor.Console.log({Message:"The selected result has not been validated. Update mapping parameter and try again.",Gravity:"Error"}),this;let t="Form_PushLayout",i=t+"_output",a="";a+='<fieldset><legend>Notice</legend>Use this tool to push the layout data into the current result file.<p class="Error">Only 5000 rows will be processed, to prevent the browser to run out of memory.</p>',a+="Range data will be resolved to their definition (if they exist) for the definition plate currently selected.<br>",a+="Please ensure the desired plate is selected before continuing.</fieldset>",a+='<div><p id="'+i+'">Press the start button below when ready to continue</div>';return Form.open({ID:t,HTML:'<fieldset><legend>Notice</legend>Use this tool to push the layout data into the current result file.<p class="Error">Only 5000 rows will be processed, to prevent the browser to run out of memory.</p>Range data will be resolved to their definition (if they exist) for the definition plate currently selected.<br>Please ensure the desired plate is selected before continuing.</fieldset><div><p id="Form_PushLayout_output">Press the start button below when ready to continue</div>',Size:500,Title:"Push layout",Buttons:[{Label:"Start",Click:function(){GetId(i).innerHTML='<span class="Error">Preparing file, please wait...</span>',e.pushLayout(5e3).then((function(e){let a=Papa.unparse(e.Data,{delimiter:"\t"}),n=GetId(i);if(n){let i=URL.createObjectURL(new Blob([a],{type:"text/plain;charset=utf-8"})),l='<span class="Success">Completed.</span>';e.Aborted&&(l='<span class="Error">Aborted after 5000 rows!<br>Consider reducing the size of your file.</span>'),n.innerHTML=l+'<p>Click <a href="'+i+'" download="Merged_Data.txt">here</a> to download the generated file</p>',Form.replaceButtons(t,[{Label:"Close",Click:function(){URL.revokeObjectURL(i),Form.close(t)}}])}}))}},{Label:"Cancel",Click:function(){Form.close(t)}}]}),this}}class TypeMap{constructor(e){return this.Plate=e,this.Map=Array(e.Rows*e.Cols),this}static valueForType(e){switch(e){case"Positive Control":return 0;case"Negative Control":return 1;case"Sample":return 2;case"Range":return 3;case"Mixed+":return 4;case"Mixed-":return 5;default:return 6}}static symbolForValue(e){switch(e){case 0:return"+";case 1:return"-";case 2:return"S";case 3:return"R";case 4:return"M+";case 5:return"M-";default:return"&nbsp;"}}static colorForValue(e){switch(e){case 0:return"lightgreen";case 1:return"lightsalmon";case 2:return"white";case 3:return"lightcyan";case 4:return"khaki";case 5:return"plum";default:return"white"}}static matrix(e,t){return[[0,-1,4,4,4,-1,6],[-1,1,5,5,-1,5,6],[4,5,2,2,4,5,6],[4,5,2,3,4,5,6],[4,-1,4,4,4,-1,6],[-1,5,5,5,-1,5,6],[6,6,6,6,6,6,6]][e][t]}static checkCompatibility(e,t,i){if(void 0===e||void 0===t)return!0;if(-1==e||-1==t)return!1;let a=this.matrix(e,t);return-1!=a&&!(i&&a>3)}static reduce(e){if(e.length>0){return e.reduce((function(e,t){return TypeMap.matrix(e,t)}))}}static getConflicts(e){var t=[];return e.Map.forEach((function(e,i){e>3&&t.push(i)})),t}get(e){return this.Map[e]}types(e,t){let i=[];return this.Plate.Layers.forEach((function(a){if(a.Index!=t){let t=a.Wells[e];t.Area&&i.push(TypeMap.valueForType(t.Area.Type))}})),i}log(e,t){let i=this.Map[e],a=TypeMap.valueForType(t);return this.Map[e]=void 0!==i?TypeMap.matrix(i,a):a,this}unlog(e,t){let i=this.types(e,t);this.Map[e]=TypeMap.reduce(i)}resize(e,t){let i=this.Plate.Rows,a=this.Plate.Cols,n=[],l=0;for(;l<e;){let e=0;for(;e<t;){if(e<a&&l<i){let t=this.Map[a*l+e];t?n.push(t):n.push(void 0)}else n.push(void 0);e++}l++}return this.Map=n,this}draw(){let e=this.Plate.Rows,t=this.Plate.Cols,i='<table class="PlateTable"><tr><th></th>';for(let e=0;e<t;e++)i+="<th>"+(e+1)+"</th>";i+="</tr>";for(let a=0;a<e;a++){i+="<tr><th>"+Well.alphabet(a)+"</th>";for(let e=0;e<t;e++){let n=this.Map[a*t+e];i+='<td style="background-color: '+TypeMap.colorForValue(n)+'">'+TypeMap.symbolForValue(n)+"</td>"}i+="</tr>"}return i+="</table>",i+='<p style="font-size:0.8em">+: Positive Control; -: Negative Control; S: Sample; R: Range; M+/-: Mixed sample or range with control</p>',i}}class Well{constructor(e){return this.Layer=e.Layer,this.Index=e.Index,this.Row=e.Row,this.Col=e.Col,this.Value=void 0,this.Conc=void 0,this.Unit=void 0,this.RangeIndex=1,this.Area=void 0,this.Selected=!1,this.Duplicate=!1,this.Error=!1,this}static alphabet(e){var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];return e<26?t[e]:"A"+t[e-26]}static dose(e){return void 0===e||void 0===e.Conc?"":"MOI"==e.Unit?"MOI "+e.Conc:"%"==e.Unit||"×"==e.Unit?e.Conc+e.Unit:e.Conc+" "+e.Unit}static parseIndex(e,t){if(void 0===e||void 0===t||void 0===e.search)return;let i=t.Cols,a=t.Rows;if(e.search(/[a-z]{1,2}[0-9]{1,3}/i)<0)return;let n=e.match(/[a-z]{1,2}/i),l=e.match(/[0-9]{1,3}/),s=parseInt(l,10)-1;if(s>=i)return;let r=Well.rowIndex(n);return void 0===r||r>=a?void 0:{Index:r*i+s,Row:r,Col:s}}static rowIndex(e){return 1==e.length?parseInt(e,36)-10:2==e.length?26*(parseInt(e.charAt(0),36)-9)+parseInt(e.charAt(1),36)-10:void 0}static layoutData(e,t){let i=[""];e.Value?i.push(e.Value,e.Unit):i.push("","");let a=e.Area;return a&&("Range"==a.Type?a.Definition?i[0]=t[a.Name][e.Index]:i[0]=a.Name+" #"+e.RangeIndex:i[0]=a.Name),i}static save(e){return{Index:e.Index,Value:e.Value,Unit:e.Unit,RangeIndex:e.RangeIndex}}get Name(){return Well.alphabet(this.Col)+(this.Row+1)}x(e){return(this.Col+1)*e}y(e){return(this.Row+1)*e}content(e,t,i){let a=t+i,n=i/2,l=this.x(a),s=this.y(a);return e.clearRect(l-n,s-n,t+i,t+i),e.save(),(this.Selected||this.Duplicate||this.Error)&&(e.strokeStyle="dodgerblue",this.Duplicate&&(e.strokeStyle="darkorange",this.Duplicate=!1),this.Error&&(e.strokeStyle="darkred",this.Error=!1),e.lineWidth=3,e.strokeRect(l,s,t,t),this.Area&&(e.lineWidth=1,e.strokeStyle="black",e.strokeRect(l+n,s+n,t-i,t-i))),this.Area&&(e.fillStyle=this.Area.Color,e.fillRect(l+n+1,s+n+1,t-i-2,t-i-2),"Range"==this.Area.Type&&(e.fillStyle=CSSCOLORS.font(this.Area.Color),e.font=4*Math.floor(i/2)+3+"px arial",e.textAlign="center",e.textBaseline="middle",e.fillText(this.RangeIndex,l+.5*t,s+.4*t,t))),this.Conc&&(this.Area?e.fillStyle=CSSCOLORS.font(this.Area.Color):e.fillStyle="black",e.font=2*Math.floor(i/2)+3+"px arial",e.textAlign="center",e.textBaseline="middle",e.fillText(Well.dose(this),l+.5*t,s+.75*t,t)),e.restore(),this}tag(e,t){if(0==t.Keep&&(this.Selected=!1),this.Area){if(this.Area.Name==e.Name)return this.Duplicate=!0,this;if(t.Lock)return this.Error=!0,this;var i=TypeMap.reduce(t.Map.types(this.Index,t.Layer.Index))}else i=t.Map.get(this.Index);return TypeMap.checkCompatibility(i,TypeMap.valueForType(e.Type),t.Strict)?(this.Area&&this.untag(t),this.Area=e,"Range"==e.Type&&e.Custom&&(this.RangeIndex=t.RangeIndex),t.Map.log(this.Index,e.Type),this):(this.Error=!0,this)}untag(e){0==e.Keep&&(this.Selected=!1);let t=this.Area;if(t){if(Area.unlog(t,e.Layer,this),e.Map.unlog(this.Index,e.Layer.Index),"Range"==t.Type){t.Custom&&(this.RangeIndex=0);let i=t.Name;-1==e.Results.Ranges.findIndex((function(e){return e.Name==i}))&&e.Results.Ranges.push(t)}this.Area=void 0}return this}tagConc(e){return this.Value=e.Value,this.Conc=Decimal.format(e.Value,e.Digit),this.Unit=e.Unit,this}untagConc(){return this.Value=void 0,this.Conc=void 0,this.Unit=void 0,this}changeDigit(e){return this.Conc=Decimal.format(this.Value,e),this}}
//# sourceMappingURL=editor.min.js.map

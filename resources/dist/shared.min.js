function Form_Color(e){this.Selected="white",e&&e.Caller&&(this.Selected=e.Caller.getValue());var t="";CSSCOLORS.list().forEach((function(e){t+='<div class="ColorBlock" style="float: left; background-color: '+e+'" title="'+e+'"></div>'})),t+='<div style="clear: both; padding-top: 10px; text-align: center">Selected:&nbsp;',t+='<span id="Form_ColorSelected" class="ColorBlock" style="background-color: '+this.Selected+'" title="'+this.Selected+'">&nbsp;&nbsp;&nbsp;&nbsp;</span>',t+="</div>";var i="Form_Color";Form.open({ID:i,HTML:t,Title:"Color Picker",Buttons:[{Label:"Ok",Title:"Apply the selected color",Click:function(){if(e){var t=this.Selected;e.Caller&&e.Caller.setValue(t),e.after&&e.after(t)}Form.close(i)}.bind(this)},{Label:"Cancel",Click:function(){Form.close(i)}}],onInit:function(){var e=GetId("Form_ColorSelected"),t=document.getElementsByClassName("ColorBlock"),i=t.length;for(let r=0;r<i;r++)t.item(r).addEventListener("click",function(t){var i=t.target.style.backgroundColor;this.Selected=i,e.style.backgroundColor=i,e.title=i}.bind(this))}.bind(this)})}class Form_Import{constructor(){}static open(e){this.init(e),e.Single?this.Multiple=!1:this.Multiple=!0,this.Chain=e.Chain,this.Controls.File.Multiple=this.Multiple;let t="Data Import";return e&&e.Title&&(t=e.Title),Form.open({ID:this.ID,HTML:this.html(),Title:t,Size:800,Buttons:this.Buttons.Step1,onInit:function(){this.bindEvents()}.bind(this),onCancel:function(){this.cancel()}.bind(this)}),e&&e.OnClose&&(this.OnClose=e.OnClose),this}static init(e){if(!this.Init){var t="Form_Import";return this.ID=t,this.Anchors={Input:t+"_Input",Table:t+"_InputTable",InputType:t+"_InputType",InputSelection:t+"_InputSelection",Parsing:t+"_Parsing",Parser:t+"_Parser",ParserOptions:t+"_ParserOptions",Preview:t+"_Preview",PreviewBox:t+"_PreviewBox",WaitMask:t+"_WaitMask",WaitMaskCurrent:t+"_WaitMaskCurrent",WaitMaskTotal:t+"_WaitMaskTotal",WaitMaskList:t+"_WaitMaskList"},this.Controls={File:LinkCtrl.new("File",{ID:this.Anchors.Input,Default:"",Accept:".txt,.csv,.xls,.xlsx"}),ManualName:LinkCtrl.new("Text",{ID:this.Anchors.Input,Default:"",Label:"Name",Title:"Type a name for your data here"}),Manual:LinkCtrl.new("TextArea",{ID:this.Anchors.Input,Default:"",Preserve:!0,Index:1,Title:"Type or paste your data here"}),Table:new RespTable({ID:this.Anchors.Table,Fields:["Name","Format","Source","Type"],RowNumbers:!0,Preserve:!0,onSelect:function(e,t,i,r){this.selectInput(i,r)}.bind(this)}),InputType:LinkCtrl.new("Radio",{ID:this.Anchors.InputType,List:["From file(s)","Manual input"],Default:0,ControlLeft:!0,Change:function(){this.changeInputType()}.bind(this),Title:"Type of input desired"}),Preview:LinkCtrl.new("Checkbox",{ID:this.Anchors.Preview,Default:!0,Label:"Show",NewLine:!0,Change:function(){this.togglePreview()}.bind(this),Title:"Tick to display a preview of the parsing results"})},this.Buttons={Step1:[{Label:"Next",Click:function(){this.next()}.bind(this)},{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){this.cancel()}.bind(this)}],Step2:[{Label:"Back",Icon:{Type:"Back",Space:!0},Click:function(){this.back()}.bind(this)},{Label:"Done",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){this.done()}.bind(this)},{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){this.cancel()}.bind(this)}]},this.Step=1,this.Init=!0,this}}static bindEvents(){var e=LinkCtrl.button({Label:"Add",Title:"Add these inputs to the list of selected inputs",Click:function(){this.addInput()}.bind(this)});GetId(this.Anchors.InputSelection).append(e),this.Controls.Table.init(),this.Controls.InputType.init().change()}static changeInputType(){switch(this.Controls.InputType.Selected){case"From file(s)":this.Controls.File.init();break;case"Manual input":this.Controls.ManualName.init();let e=LinkCtrl.buttonBar([{Label:"Insert Tab",Click:function(){let e=this.Controls.Manual;e.setValue(e.Value+"\t"),e.focus()}.bind(this),Title:"Click to insert a Tabulation"},{Label:"Get as txt",Click:function(){Form.download(this.Controls.Manual.getValue(),{FileName:"Manual_input.txt"})}.bind(this),Title:"Click to download your manual input as a txt file"}],!0);GetId(this.Anchors.Input).insertAdjacentHTML("beforeend","&nbsp;"),GetId(this.Anchors.Input).insertAdjacentElement("beforeend",e),this.Controls.Manual.init()}return this}static addInput(){var e=this.Controls.Table;if(0==this.Multiple&&e.Length>0)return alert("Only one input allowed!"),this;switch(this.Controls.InputType.Selected){case"From file(s)":var t=this.Controls.File.getValue(),i=t.length;for(let s=0;s<i;s++){var r=InputObject.new("File",t[s]);e.addRow(r)}this.Controls.File.setValue([]);break;case"Manual input":var s=this.Controls.Manual.getValue();if(s.length>0){var n=InputObject.new("Manual",{Data:s,Name:this.Controls.ManualName.getValue()});e.addRow(n),this.Controls.Manual.setValue(""),this.Controls.ManualName.setValue("")}break;default:return this}return 0==e.Selected.length&&e.setValue([0]),this}static selectInput(e,t){if(e[0]==t[0])return;let i=this.Controls.Table.Selected[0];return void 0!==i&&2==this.Step&&(this.showParsingControls(i),i.InputParser.parse({Limit:i.Controls.Limit.Selected,Input:i})),this}static showParsingControls(e){this.Controls.Preview.init(),e.Controls.Limit.init(),e.Controls.Parser.init(),e.InputParser.init()}static next(){let e=this.Controls.Table;if(0==e.Length)return void alert("No input selected!");e.hideControls(),this.Step++,Form.replaceButtons(this.ID,[{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){this.close()}.bind(this)}]),this.parsingStart(e.Array);let t=e.Selected[0];void 0===t&&(e.setValue([0]),t=e.Selected[0]);let i=e.SelectedIndices[0],r=[];e.Array.forEach((function(e,t){let s=!0;t==i&&(s=!1),r.push(new Promise(function(i){e.Controls.Parser.change(void 0,{NoInit:!0,NoPreview:s,Step:function(e,i,r){let s="";0==r.FirstParsed&&(s="(Pre-parsing) - "),5e3*Math.round(i/5e3)-i==0&&(GetId(this.Anchors.WaitMaskList).children[t].children[1].innerHTML=s+i)}.bind(this),Complete:function(r){this.parsingUp(t,r),e.Status=void 0,i()}.bind(this),Error:function(r){this.parsingError(t,r),e.Status="Error",i()}.bind(this)})}.bind(this)))}),this),Promise.all(r).then(function(){this.parsingDone(),this.showParsingControls(t),e.update(),Form.replaceButtons(this.ID,this.Buttons.Step2)}.bind(this))}static back(){this.Step--,GetId(this.Anchors.InputSelection).style.display="block",GetId(this.Anchors.Parsing).style.display="none",this.Controls.Table.showControls(),Form.replaceButtons(this.ID,this.Buttons.Step1)}static togglePreview(){var e=this.Controls.Preview.getValue();GetId(this.Anchors.PreviewBox).style.display=e?"block":"none"}static parsingStart(e){this.ParsedInputs=0;let t=e.length;GetId(this.Anchors.WaitMaskTotal).innerHTML=t;let i="";for(let r=0;r<t;r++)i+="<li><span>"+e[r].Name+": </span><span>0</span><span> Rows found</span></li>";GetId(this.Anchors.WaitMaskList).innerHTML=i;let r=GetId(this.Anchors.WaitMask),s=r.nextElementSibling.children,n=Math.max(s[0].offsetHeight,s[1].offsetHeight)+"px",a=r.nextElementSibling.offsetWidth+"px";r.style.height=n,r.style.width=a,r.style.display="block"}static parsingUp(e,t){this.ParsedInputs++,GetId(this.Anchors.WaitMaskCurrent).innerHTML=this.ParsedInputs;let i=GetId(this.Anchors.WaitMaskList).children[e];i.children[1].innerHTML=t,i.insertAdjacentHTML("beforeend",". DONE"),i.style.color="green"}static parsingError(e,t){let i=GetId(this.Anchors.WaitMaskList).children[e],r=i.children[0].innerHTML;i.innerHTML="<span>"+r+"ERROR</span>",i.style.color="red"}static parsingDone(){GetId(this.Anchors.WaitMask).style.display="none",GetId(this.Anchors.InputSelection).style.display="none",GetId(this.Anchors.Parsing).style.display="block",this.togglePreview()}static done(){let e=[],t=!1;this.Controls.Table.Array.forEach((function(i){let r=i.InputParser;void 0!==i.Status&&"Error"==i.Status?t=!0:e.push({Source:i.Source,Name:i.Name,Size:r.SelectedRows+" Rows &times; "+r.SelectedCols+" Cols",Other:r.Info,Headers:r.Headers,Parser:r,Input:i})})),t?Form.open({ID:this.ID+"_Confirm",HTML:'<p style="color: tomato; padding:0em 1em">Inputs on error will not be exported. Are you sure you want to continue?</p>',Title:"Confirm export",Buttons:[{Label:"Ok",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){Form.close(this.ID+"_Confirm"),this.close(e)}.bind(this)},{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(this.ID+"_Confirm")}.bind(this)}],onCancel:function(){Form.close(this.ID+"_Confirm")}.bind(this)}):this.close(e)}static reset(){return this.Controls.Table.empty(),this.Step=1,this}static cancel(){this.reset(),Form.close(this.ID)}static close(e){return this.OnClose&&this.OnClose(e),void 0!==this.Chain&&0!=this.Chain||this.cancel(),this}static html(){var e="";return e+="<div id="+this.Anchors.WaitMask+' class="Form_Import_DisableMask">',e+="<p><b>Parsing in progress, Please wait...</b></p>",e+="<p><i>Parsed: <span id="+this.Anchors.WaitMaskCurrent+">0</span> / <span id="+this.Anchors.WaitMaskTotal+"></span></i></p>",e+="<ul id="+this.Anchors.WaitMaskList+"></ul>",e+="</div>",e+="<div>",e+='<div class="Form_Import_Left">',e+="<fieldset><legend>Inputs selected</legend>",e+='<div id="'+this.Anchors.Table+'" style="width: 320px; overflow: auto"></div>',e+="</fieldset>",e+="</div>",e+='<div class="Form_Import_Right">',e+='<fieldset id="'+this.Anchors.InputSelection+'"><legend>Input selection</legend>',e+='<div id="'+this.Anchors.InputType+'"></div>',e+='<div id="'+this.Anchors.Input+'"></div>',e+="</fieldset>",e+='<fieldset id="'+this.Anchors.Parsing+'" style="display: none"><legend>Parsing</legend>',e+='<div id="'+this.Anchors.Parser+'" style="margin-bottom: 10px;"></div>',e+='<fieldset style="float: left;"><legend><i>Options</i></legend>',e+='<div id="'+this.Anchors.ParserOptions+'"></div>',e+="</fieldset>",e+="<fieldset><legend><i>Preview</i></legend>",e+='<div id="'+this.Anchors.Preview+'"></div>',e+='<div id="'+this.Anchors.PreviewBox+'" class="Form_Import_Preview"></div>',e+="</fieldset>",e+="</fieldset>",e+="</div>",e+="</div>"}}class CSSCOLORS{constructor(){}static list(e){switch(e){case"RGB":return[[135,206,250],[144,238,144],[255,182,193],[221,160,221],[240,230,140],[211,211,211],[255,255,240],[224,255,255],[255,240,245],[127,255,212],[255,218,185],[176,224,230],[176,196,222],[255,160,122],[169,169,169],[218,112,214],[255,255,224],[250,250,210],[255,239,213],[173,255,47],[255,255,0],[0,255,255],[255,228,181],[102,205,170],[240,255,255],[240,128,128],[245,255,250],[255,192,203],[188,143,143],[255,250,205],[127,255,0],[255,250,240],[255,228,196],[255,250,250],[255,255,255],[152,251,152],[238,232,170],[220,220,220],[216,191,216],[64,224,208],[248,248,255],[175,238,238],[240,255,240],[255,248,220],[245,222,179],[0,255,0],[240,248,255],[124,252,0],[255,215,0],[255,245,238],[230,230,250],[245,245,245],[173,216,230],[210,180,140],[253,245,230],[250,128,114],[32,178,170],[245,245,220],[255,140,0],[0,191,255],[50,205,50],[255,235,205],[0,250,154],[135,206,235],[250,240,230],[192,192,192],[154,205,50],[250,235,215],[189,183,107],[255,105,180],[218,165,32],[255,228,225],[255,222,173],[0,255,127],[222,184,135],[255,165,0],[238,130,238],[143,188,143],[244,164,96],[0,206,209],[255,127,80],[60,179,113],[233,150,122],[72,209,204],[255,99,71],[100,149,237],[205,133,63],[95,158,160],[219,112,147],[255,0,255],[30,144,255],[184,134,11],[255,69,0],[210,105,30],[255,20,147],[119,136,153],[147,112,219],[107,142,35],[186,85,211],[128,128,128],[205,92,92],[255,0,0],[112,128,144],[70,130,180],[0,139,139],[123,104,238],[128,128,0],[46,139,87],[34,139,34],[0,128,128],[65,105,225],[220,20,60],[0,128,0],[106,90,205],[199,21,133],[105,105,105],[160,82,45],[153,50,204],[85,107,47],[138,43,226],[148,0,211],[178,34,34],[165,42,42],[139,69,19],[0,100,0],[139,0,139],[0,0,255],[47,79,79],[72,61,139],[128,0,128],[139,0,0],[128,0,0],[0,0,205],[75,0,130],[25,25,112],[0,0,139],[0,0,128],[0,0,0]];case"RGBSimple":return[[0,0,255],[0,128,0],[128,0,0],[255,165,0],[238,130,238],[128,128,0],[128,0,128],[0,139,139],[255,0,0],[128,128,128],[255,0,255],[70,130,180],[154,205,50],[250,128,114],[72,61,139],[0,0,0]];case"Hexa":return["87CEFA","90EE90","FFB6C1","DDA0DD","F0E68C","D3D3D3","FFFFF0","E0FFFF","FFF0F5","7FFFD4","FFDAB9","B0E0E6","B0C4DE","FFA07A","A9A9A9","DA70D6","FFFFE0","FAFAD2","FFEFD5","ADFF2F","FFFF00","00FFFF","FFE4B5","66CDAA","F0FFFF","F08080","F5FFFA","FFC0CB","BC8F8F","FFFACD","7FFF00","FFFAF0","FFE4C4","FFFAFA","FFFFFF","98FB98","EEE8AA","DCDCDC","D8BFD8","40E0D0","F8F8FF","AFEEEE","F0FFF0","FFF8DC","F5DEB3","00FF00","F0F8FF","7CFC00","FFD700","FFF5EE","E6E6FA","F5F5F5","ADD8E6","D2B48C","FDF5E6","FA8072","20B2AA","F5F5DC","FF8C00","00BFFF","32CD32","FFEBCD","00FA9A","87CEEB","FAF0E6","C0C0C0","9ACD32","FAEBD7","BDB76B","FF69B4","DAA520","FFE4E1","FFDEAD","00FF7F","DEB887","FFA500","EE82EE","8FBC8F","F4A460","00CED1","FF7F50","3CB371","E9967A","48D1CC","FF6347","6495ED","CD853F","5F9EA0","DB7093","FF00FF","1E90FF","B8860B","FF4500","D2691E","FF1493","778899","9370DB","6B8E23","BA55D3","808080","CD5C5C","FF0000","708090","4682B4","008B8B","7B68EE","808000","2E8B57","228B22","008080","4169E1","DC143C","008000","6A5ACD","C71585","696969","A0522D","9932CC","556B2F","8A2BE2","9400D3","B22222","A52A2A","8B4513","006400","8B008B","0000FF","2F4F4F","483D8B","800080","8B0000","800000","0000CD","4B0082","191970","00008B","000080","000000"];case"HexaSimple":return["0000FF","008000","800000","FFA500","EE82EE","808000","800080","008B8B","FF0000","808080","FF00FF","4682B4","9ACD32","FA8072","483D8B","000000"];case"Simple":return["blue","green","maroon","orange","violet","olive","purple","darkcyan","red","gray","magenta","steelblue","yellowgreen","salmon","darkslateblue","black"];default:return["lightskyblue","lightgreen","lightpink","plum","khaki","lightgray","ivory","lightcyan","lavenderblush","aquamarine","peachpuff","powderblue","lightsteelblue","lightsalmon","darkgray","orchid","lightyellow","lightgoldenrodyellow","papayawhip","greenyellow","yellow","cyan","moccasin","mediumaquamarine","azure","lightcoral","mintcream","pink","rosybrown","lemonchiffon","chartreuse","floralwhite","bisque","snow","white","palegreen","palegoldenrod","gainsboro","thistle","turquoise","ghostwhite","paleturquoise","honeydew","cornsilk","wheat","lime","aliceblue","lawngreen","gold","seashell","lavender","whitesmoke","lightblue","tan","oldlace","salmon","lightseagreen","beige","darkorange","deepskyblue","limegreen","blanchedalmond","mediumspringgreen","skyblue","linen","silver","yellowgreen","antiquewhite","darkkhaki","hotpink","goldenrod","mistyrose","navajowhite","springgreen","burlywood","orange","violet","darkseagreen","sandybrown","darkturquoise","coral","mediumseagreen","darksalmon","mediumturquoise","tomato","cornflowerblue","peru","cadetblue","palevioletred","magenta","dodgerblue","darkgoldenrod","orangered","chocolate","deeppink","lightslategray","mediumpurple","olivedrab","mediumorchid","gray","indianred","red","slategray","steelblue","darkcyan","mediumslateblue","olive","seagreen","forestgreen","teal","royalblue","crimson","green","slateblue","mediumvioletred","dimgray","sienna","darkorchid","darkolivegreen","blueviolet","darkviolet","firebrick","brown","saddlebrown","darkgreen","darkmagenta","blue","darkslategray","darkslateblue","purple","darkred","maroon","mediumblue","indigo","midnightblue","darkblue","navy","black"]}}static cutOff(e){return e&&e.Luminescence?.17913:109}static fetch(e,t){var i=this.list(t);return i[e%i.length]}static fetchIndex(e,t){return this.list(t).findIndex((function(t){return t==e}))}static fetchRGB(e,t){let i=this.list("RGB")[this.fetchIndex(e)];return t?"rgb("+i[0]+","+i[1]+","+i[2]+")":i}static font(e,t){if(void 0!==t&&"RGB_Unnamed"==t){let t=e.match(/\d+/g).map((function(e){let t=e/255;return t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4)}));return.2126*t[0]+.7152*t[1]+.0722*t[2]<this.cutOff({Luminescence:!0})?"white":"black"}let i=this.list(t).findIndex((function(t){return t==e}));if(i>-1){return i<this.cutOff()?"black":"white"}return"black"}static heatmap(e,t,i,r){if(t==i)return"rgb("+r[1][0]+", "+r[1][1]+", "+r[1][2]+")";if(.5==(e=(e-t)/(i-t)))return"rgb("+r[1][0]+", "+r[1][1]+", "+r[1][2]+")";if(e<.5)var s=r[0][0]+2*(r[1][0]-r[0][0])*e,n=r[0][1]+2*(r[1][1]-r[0][1])*e,a=r[0][2]+2*(r[1][2]-r[0][2])*e;if(e>.5)s=r[1][0]+2*(r[2][0]-r[1][0])*(e-.5),n=r[1][1]+2*(r[2][1]-r[1][1])*(e-.5),a=r[1][2]+2*(r[2][2]-r[1][2])*(e-.5);return"rgb("+Math.round(s)+", "+Math.round(n)+", "+Math.round(a)+")"}static HMtemplates(){return[["lightblue","white","tomato"],["blue","white","red"],["lightgreen","khaki","tomato"],["lightgreen","white","tomato"],["green","black","red"],["black","yellow","white"],["black","blue","white"]]}}class Decimal{constructor(e){return this.Input=e,this.InputStr=e.toString(),this.Sgn=Math.sign(e),this.Value=Math.abs(e),this.ValueStr=this.Value.toString(),this.Floor=Math.floor(this.Value),this.FloorStr=this.Floor.toString(),this.ExpPosition=this.InputStr.indexOf("e"),this.DecPosition=this.ValueStr.indexOf("."),this.Power=Math.floor(Math.log10(this.Value)),this.ExpPosition>0?(this.RawDecimalStr=this.ValueStr.substring(this.DecPosition+1,this.ExpPosition),this.PowerOffset=-(this.RawDecimalStr.length-1)):(this.DecPosition>0?this.RawDecimalStr=this.ValueStr.substring(this.DecPosition+1):this.RawDecimalStr="",this.PowerOffset=-(this.RawDecimalStr.length+this.Power)),this.Decimals=Number(this.RawDecimalStr),this.DecimalStr=this.Decimals.toString(),this.ExpPosition>0?this.PureValueStr=this.ValueStr.substring(0,this.DecPosition)+this.RawDecimalStr:0==this.Floor?this.PureValueStr=this.DecimalStr:this.PureValueStr=this.InputStr.replace(/[.]/,""),this.PureValue=Number(this.PureValueStr),this}static sgnToText(e){return e.Sgn<0?"-":""}static niceNumber(e,t){let i=0,r=!0,s=0,n=new Decimal(e),a=n.Power,l=[1,1.2,1.25,1.5,1.75,2,2.5,4,5,6,7.5,8,10];t&&(t.Power&&(a=t.Power),t.Below&&(r=!1),t.Loose&&(l=[1,2,4,5,10])),-1==n.Sgn&&(r=!r);var o=n.Value/Math.pow(10,a);o>10&&(s=10,o-=s);var h=function(e,t){return e<=t};r&&(l.reverse(),h=function(e,t){return e>=t}),l.forEach((function(e){h(e,o)&&(i=e)}));var c=n.Sgn*(s+i)*Math.pow(10,a);return t&&t.ReturnAsObject?new Decimal(c):c}static multiply(e,t,i){if(0==e||0==t)return 0;let r=new Decimal(e),s=new Decimal(t),n=r.PureValue*s.PureValue,a=r.Power+r.PowerOffset+s.Power+s.PowerOffset,l=n*Math.pow(10,a);return i?new Decimal(l):l}static format(e,t,i){let r=new Decimal(e);if(0==t||isNaN(t))return r.InputStr;let s="~";i&&i.NoTilde&&(s="");let n=r.FloorStr.length;if(r.DecPosition>0){if(r.ValueStr.length<=t+1)return r.InputStr;let e=r.RawDecimalStr.length-r.DecimalStr.length;if(0==r.Floor){if(e>0){if(r.DecimalStr.length<=t)return r.Input.toExponential(r.DecimalStr.length-1);{s+=Decimal.sgnToText(r);let i=r.DecimalStr.split("");Number(i[t])>4&&i[t-1]++;for(let e=0;e<t;e++)s+=1==e?"."+i[e]:i[e];return s+"e-"+(e+1)}}return r.DecimalStr.length<=t?r.InputStr:(s+=Decimal.sgnToText(r),s+=r.Input.toFixed(t),s)}if(n>t-1)return s+r.Input.toExponential(t-1);{let e=t-n;s+=Decimal.sgnToText(r)+r.FloorStr+".";let i=r.DecimalStr.split("");Number(i[e])>4&&i[e-1]++;for(let t=0;t<e;t++)s+=i[t];return s}}if(r.ValueStr.length<=t)return r.InputStr;for(var a=n;"0"==r.FloorStr.substring(a,a-1);)a--;if(n-a>0){var l=r.FloorStr.substring(0,a).length;return l>0&&l<=t?r.Input.toExponential(l-1):s+r.Input.toExponential(t-1)}return s+r.Input.toExponential(t-1)}}class InputObject{constructor(){this.Controls={Parser:LinkCtrl.new("Select",{ID:Form_Import.Anchors.Parser,Label:"Parser",Default:0,List:["TXT/CSV","XLSX","XLS"],Title:"The parser to use to parse this input",Change:function(e,t){t?t.Input=this:t={Input:this},this.changeParser(t)}.bind(this)}),Limit:LinkCtrl.new("Select",{ID:Form_Import.Anchors.Preview,Index:1,Default:0,Label:"Limit",Preserve:!0,List:["20","100","500","1000","All"],Title:"Only this number of rows will be displayed in the preview. Prevent big files from crashing the browser.",Change:function(){this.InputParser.parse({Limit:this.Controls.Limit.Selected,Input:this})}.bind(this)})}}static new(e,t){switch(e){case"File":return new InputObject_File(t);case"Manual":return new InputObject_Manual(t);default:return void console.error("Unknown type requested for InputObject ("+e+"). Aborted.")}}changeParser(e){this.InputParser=InputParser.new({Type:this.Controls.Parser.Selected,Data:this.RawData,Name:this.Name}),e?e.Limit=this.Controls.Limit.Selected:e={Limit:this.Controls.Limit.Selected},this.InputParser.parse(e),e&&e.NoInit||this.InputParser.init()}}class InputParser{constructor(e){this.RawData=e.Data,this.Name=e.Name,this.WebWorker=!0,this.TotalRows=0,this.TotalCols=0,this.SelectedRows=0,this.SelectedCols=0,this.Headers=[],this.Info="",this.Limit=1/0,this.FirstParsed=!1,this.Error=!1;let t=Form_Import.Anchors.ParserOptions,i=function(){this.parse()}.bind(this);return this.Options={NoHeaders:LinkCtrl.new("Checkbox",{ID:t,Label:"No headers",Default:!1,Change:i,NewLine:!0,Title:"If ticked, arbitrary, default headers will be used instead of the values found in the first line"}),FirstRow:LinkCtrl.new("Number",{ID:t,Label:"First Row",Default:1,Min:1,Preserve:!0,NewLine:!0,Index:1,Change:i,Title:"Line at which the import is started"}),FirstCol:LinkCtrl.new("Number",{ID:t,Label:"First Column",Default:1,Min:1,Preserve:!0,NewLine:!0,Index:2,Change:i,Title:"Column at which the import is started"}),SingleCol:LinkCtrl.new("Checkbox",{ID:t,Label:"Single column",Default:!1,Preserve:!0,NewLine:!0,Index:3,Change:i,Title:"If ticked, only one column of data will be selected for import"}),SkipEmptyRows:LinkCtrl.new("Checkbox",{ID:t,Label:"Skip empty rows",Default:!0,Preserve:!0,NewLine:!0,Index:4,Change:i,Title:"Whether empty rows are skipped"})},this}static new(e){switch(e.Type){case"TXT/CSV":return new InputParser_Papa(e);case"XLSX":return new InputParser_XLSX(e);case"XLS":return new InputParser_XLS(e);default:return void console.error("Unknown type requested for InputParser ("+e.Type+"). Aborted.")}}static highlight(e){return'<b><i><span style="color: salmon">'+e+"</span></b></i>"}init(){return Object.values(this.Options).forEach((function(e){e.init()})),this}resetParsing(e){return this.SelectedRows=0,this.SelectedCols=0,this.Error=!1,e&&e.NoPreview||(GetId(Form_Import.Anchors.PreviewBox).innerHTML="<p>"+InputParser.highlight("Preparing preview, please wait...")+"</p>"),this}setLimit(e){return e&&"All"!=e.Limit?this.Limit=parseInt(e.Limit):this.Limit=1/0,this}parsingOptions(){let e={NoHeaders:this.Options.NoHeaders.getValue(),FirstRow:this.Options.FirstRow.getValue()-1,FirstCol:this.Options.FirstCol.getValue()-1,SingleCol:this.Options.SingleCol.getValue(),SkipEmptyRows:this.Options.SkipEmptyRows.getValue(),LastCol:this.TotalCols,FirstParsed:this.FirstParsed,Index:0,Selected:-1};return e.SingleCol&&(e.LastCol=e.FirstCol+1),e}processRow(e,t,i,r){(e=this.cleanRow(e,r))&&(-1==r.Selected?(this.header(e,r),r.NoHeaders||0==this.FirstParsed||r.ApplyToHeader?(i(e,0,t,r),r.Selected=1):r.Selected=0):(i(e,r.Selected,t,r),r.Selected++)),r.Index++}cleanRow(e,t){if(0==t.FirstParsed)return e;if(t.Index>=t.FirstRow){let i=[],r=!1;for(let s=t.FirstCol;s<t.LastCol;s++)void 0===e[s]||""==e[s]?i.push(""):(i.push(e[s]),r=!0);return t.SkipEmptyRows&&0==r?void 0:i}}parse(e){let t=Form_Import.Controls.Table;if(this.Error)return this.previewRow([],void 0,{Error:!0}),e&&e.Input&&(e.Input.Status="Error",t.update()),this;if(this.resetParsing(e),0==this.FirstParsed)return this.firstParse(e),this;e&&this.setLimit(e);let i=this.Name,r=!0;e&&e.NoPreview&&(r=!1),this.stream(function(s,n,a,l){if(r){t.Selected[0].Name!=i?a.abort():0==n?this.previewRow(s,l,{Start:!0}):n<this.Limit&&r&&this.previewRow(s,l)}e&&e.Step&&e.Step(s,n,a)}.bind(this),function(s,n){-1==s?(this.SelectedRows=0,this.SelectedCols=0):(this.SelectedRows=s,this.SelectedCols=this.Headers.length),r&&t.Selected[0].Name==i&&this.previewRow([],n,{Last:!0}),e&&e.Input&&(e.Input.Status=void 0,t.update()),e&&e.Complete&&e.Complete(s)}.bind(this),{ApplyToHeader:!0})}chunk(e,t){}bulk(e){let t=[];this.stream(function(e,i,r,s){t.push(e)}.bind(this),(function(i,r){e(t)}))}header(e,t){return this.Headers=[],t.NoHeaders?e.forEach((function(e,t){this.Headers.push("Col_"+(t+1))}),this):e.forEach((function(e,t){""==e?this.Headers.push("Col_"+(t+1)):this.Headers.push(e)}),this),this}previewHeader(){let e="<tr>";return this.Headers.forEach((function(t){e+="<th>"+t+"</th>"})),e+="</tr>",e}previewRow(e,t,i){let r="";if(i&&i.Start){if(r+="<div><p>"+InputParser.highlight("Preparing preview, please wait...")+"</p>",r+="* Total available Rows: <b>"+this.TotalRows+"</b>; Columns: <b>"+this.TotalCols+"</b>",r+="</div><div><table>",r+=this.previewHeader(),r+="</table></div>",GetId(Form_Import.Anchors.PreviewBox).innerHTML=r,!t.NoHeaders)return this;r=""}if(i&&i.Last){let e=this.SelectedRows;return r+="* Total available Rows: <b>"+this.TotalRows+"</b>; Columns: <b>"+this.TotalCols+"</b>",r+="<br>* Selected Rows: <b>"+e+"</b>",0==t.NoHeaders&&(r+=" (including header row)"),r+="; Columns: <b>"+this.SelectedCols+"</b>",e>this.Limit&&(r+=InputParser.highlight("<br>Now showing only "+this.Limit+" rows.")),GetId(Form_Import.Anchors.PreviewBox).children[0].innerHTML=r,this}if(i&&i.Error)return r="<p>"+InputParser.highlight("Parsing failed!")+"</p><p>Reason:<br>"+this.ErrorDetails+"</p><p>Try with a different parser or validate the input before trying again</p>",GetId(Form_Import.Anchors.PreviewBox).innerHTML=r,this;e.forEach((function(e,t){r+="<td>",r+=""==e?InputParser.highlight("&Oslash;"):e,r+="</td>"})),GetId(Form_Import.Anchors.PreviewBox).children[1].children[0].insertRow().insertAdjacentHTML("beforeend",r)}}class Mapper{constructor(){return this}static well(e){let t=!0;return e&&e.Required&&(t=!1),{Name:"Well ID",Optional:t,Guess:function(e,t){return e.search(/well/i)>-1}}}static plate(){return{Name:"Plate ID",Optional:!0,Guess:function(e,t){return e.search(/barcode/i)>-1||e.search(/plate/i)>-1}}}static definition(){return{Name:"Definition"}}static import(){return{Name:"Import",Multiple:!0}}static numeric(){return{Name:"Numeric",Multiple:!0,Optional:!0,Guess:function(e,t){return void 0===t.search||-1==t.search(/[a-z]/gi)}}}static anchors(e){let t="Mapper";switch(e){case"Table":return t+"_inputTable";case"Param":return t+"_Parameters";default:return t}}static map(e,t){if(void 0===e||0==e.length)return void console.warn("No inputs provided to the mapper");if(void 0===t||null==t.Parameters||0==t.Parameters.length)return void console.warn("Mandatory options not passed to the mapper");let i=new RespTable({ID:Mapper.anchors("Table"),Array:e,Fields:["Name","Size"],Preserve:!0,RowNumbers:!0,NoControls:!0,onSelect:function(e){e.length>0&&Mapper.showMapping(e[0],i,t)}}),r="";r+='<div id="'+Mapper.anchors("Table")+'" style="float:left; width:300px; overflow:auto;"><p><b>Inputs available:</b></p></div>',r+='<div style="margin-left:320px">',r+="<p><b>Parameter mapping:</b></p>",r+='<div id="'+Mapper.anchors("Param")+'" style="max-height:500px; overflow:auto"></div>',r+="</div>";let s="Form_ParameterMapping",n=[{Label:"Done",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){t.Validate&&0==Mapper.validate(e,t)||(t.Done&&t.Done(),t.BackToImport&&Form_Import.cancel(),Form.close(s))}}];t.BackToImport&&n.unshift({Label:"Back to parsing",Icon:{Type:"Back",Space:!0},Click:function(){e.slice(0,t.Index),Form.close(s)}}),Form.open({ID:s,HTML:r,Title:"Parameter mapping",Size:800,Buttons:n,onInit:function(){i.init(),0==i.Selected.length&&i.setValue([0]),Mapper.showMapping(i.Selected[0],i,t)}})}static showMapping(e,t,i){void 0===e.FirstRow?(GetId(Mapper.anchors("Param")).innerHTML='<p class="Error">Processing file, please wait...</p>',e.Parser.stream((function(t,i,r){e.FirstRow=t,r.abort()}),(function(){Mapper.guess(e,i),e.Name==t.Selected[0].Name&&Mapper.mappingArray(e,t,i)}))):Mapper.mappingArray(e,t,i)}static guess(e,t){e.Parser.Headers.forEach((function(i,r){t.Parameters.forEach((function(t,s){t.Guess&&t.Guess(i,e.FirstRow[r])&&Mapper.assign(e,t,r)}))}))}static mappingArray(e,t,i){let r='<span class="FootNote">Fields marked with * are mandatory</span>';r+='<table class="RespTable"><thead><tr><th>#</th><th>Name</th>',i.Parameters.forEach((function(e){r+="<th>"+e.Name,e.Optional||(r+='<span class="Error">*</span>'),e.Multiple&&(r+='<br><span class="Hyperlink">All</span>&nbsp;/&nbsp;<span class="Hyperlink">None</span>'),r+="</th>"})),r+="</tr></thead>",e.Parser.Headers.forEach((function(t,s){r+="<tr><td>"+(s+1)+"</td><td>"+t+"</td>",i.Parameters.forEach((function(t,i){r+='<td style="transform: scale(0.8)" class="RespTable_Row',void 0!==e.Mapping&&void 0!==e.Mapping[t.Name]&&(t.Multiple?e.Mapping[t.Name][s]&&(r+=" RespTable_Selected Mapped"+i):e.Mapping[t.Name]==s&&(r+=" RespTable_Selected Mapped"+i)),r+='"></td>'})),r+="</tr>"})),r+="</table>";let s=GetId(Mapper.anchors("Param"));s.innerHTML=r,s.children[1].addEventListener("click",(function(r){let n=r.target;switch(n.nodeName){case"TD":let r=n.parentElement.rowIndex-1,a=n.cellIndex;if(a>1){let t=i.Parameters[a-2];if(t.Multiple)n.className.includes("RespTable_Selected")?n.className="RespTable_Row":n.className="RespTable_Row RespTable_Selected Mapped"+(a-2);else if(n.className.includes("RespTable_Selected"))t.Optional&&(n.className="RespTable_Row");else{let e=s.getElementsByClassName("Mapped"+(a-2));e&&e[0]&&(e[0].className="RespTable_Row"),n.className="RespTable_Row RespTable_Selected Mapped"+(a-2)}Mapper.assign(e,t,r),i.OnChange&&i.OnChange(e)}t.update();break;case"SPAN":let l=n.parentElement.cellIndex,o="RespTable_Row",h=!1;"All"==n.innerHTML&&(o="RespTable_Row RespTable_Selected Mapped"+(l-2),h=!0),e.Parser.Headers.forEach((function(t,r){s.children[1].rows[r+1].cells[l].className=o,Mapper.assign(e,i.Parameters[l-2],r,{Select:h})})),i.OnChange&&i.OnChange(e),t.update()}}))}static assign(e,t,i,r){void 0===e.Mapping&&(e.Mapping={});let s=t.Name;t.Multiple?(void 0===e.Mapping[s]&&(e.Mapping[s]=Array(e.Parser.Headers.length).fill(!1)),r?r.Select?e.Mapping[s][i]=!0:e.Mapping[s][i]=!1:e.Mapping[s][i]=!e.Mapping[s][i]):t.Optional&&e.Mapping[s]==i?e.Mapping[s]=-1:e.Mapping[s]=i}static validate(e,t){let i=t.Parameters.length,r=!0,s=0;for(;r&&s<i;){let i=t.Parameters[s];if(void 0===i.Optional||0==i.Optional){let t=e.length,s=0;for(;r&&s<t;){if(void 0===e[s].Mapping||void 0===e[s].Mapping[i.Name]?r=!1:i.Multiple&&(r=e[s].Mapping[i.Name].includes(!0)),!r)return alert('Parameter "'+i.Name+'" has not been assigned for input "'+e[s].Name+'".'),!1;s++}}s++}return!0}static modeWellPlate(e){let t=e[Mapper.plate().Name],i=e[Mapper.well().Name],r=!1,s=!1;return void 0!==i&&i>-1&&(r=!0),void 0!==t&&t>-1&&(s=!0),r&&s?"PlateWell":r?"Well":s?"Plate":"Direct"}static new(e){switch(Mapper.modeWellPlate(e)){case"PlateWell":return new Mapper_PlateWell(e);case"Plate":return new Mapper_Plate(e);case"Well":return new Mapper_Well(e);case"Direct":return new Mapper_Direct(e)}}static scan(e,t){if(void 0===e)return Promise.resolve({Error:"No file selected"});if(void 0===t)return console.warn("Mapper.scan is missing parameters to run"),Promise.resolve({Error:"Internal error, check console for details"});let i={Items:0,PlatesID:[]};return t.Preview&&(i.Preview="",i.Column=e.Mapping[t.Preview.Column],i.Limit=t.Preview.Limit||50,i.LimitReached=!1),e.Mapper.scan(e,t,i)}static cleanValue(e){return""==e||"Infinity"==e?void 0:Number(e)}static scanMinMax(e,t){e.Parameters.forEach((function(e,i){if(e.Numeric){let r=Mapper.cleanValue(t[i]);r>e.GlobalMax&&(e.GlobalMax=r),r<e.GlobalMin&&(e.GlobalMin=r)}}))}static scanPreviewColumns(e,t,i){if(e.Items<e.Limit){let r=e.Column;e.Items>0&&(e.Preview+="\n"),e.Preview+=i,void 0!==r&&(r.length?r.forEach((function(i,r){i&&(e.Preview+=" "+t[r])})):e.Preview+=" "+t[r])}else e.LimitReached=!0}static fillMissingElements(e,t,i,r){let s="";if(t.AreaName&&(s=t.AreaName+" "),t.FindAll&&e.length<t.RangeIndexBase0)for(;r<t.RangeIndexBase0;)e.push(s+"#"+(i+r+1)),r++;return e}}class Pair{constructor(){return this.Table=[],this}static unpaired(){let e="There are currently no definition plates paired to this result plate";return{State:"unpaired",Txt:e,Html:'<span style="font-size: 0.8em; font-style: italic" title="There are currently no definition plates paired to this result plate">Unpaired</span>&nbsp;'}}static paired(e,t){let i=" is";t>1&&(i="s are");let r="Currently "+t+" definition plate"+i+" paired to this result plate:\n",s=0;e.Table.forEach((function(e,t){t>0&&(r+="\n"),r+="- Range: "+e.RangeName+"; Plate: "+e.Name+" (#"+(e.Index+1)+")",e.Broken&&(s++,r+=" *Link Broken!*")}));let n='<span class="';return s>0?(n+='Error" style="font-size: 0.8em" title="'+r+'">Pair broken ('+s+"/"+t+")</span>&nbsp;",{State:"broken",Txt:r,Html:n,Length:t}):(n+='Success" style="font-size: 0.8em" title="'+r+'">Paired ('+t+")</span>&nbsp;",{State:"paired",Txt:r,Html:n,Length:t})}static hasItem(e,t){return e.Table.findIndex((function(e){return e.RangeName==t.RangeName}))}register(e){let t=Pair.hasItem(this,e);if(t>-1){let i=this.Table[t];i.Index=e.DefPlateIndex,i.Name=e.DefPlateName,i.Broken=!1}else this.Table.push({RangeName:e.RangeName,Index:e.DefPlateIndex,Name:e.DefPlateName,Broken:!1});return this}remove(e){let t=Pair.hasItem(this,e);return t>-1&&this.Table.splice(t,1),this}state(){let e=this.Table.length;return 0==e?Pair.unpaired():Pair.paired(this,e)}update(e){let t=this.Table.length;if(0==t)return Pair.unpaired();let i=[];return this.Table.forEach((function(t,r){let s=Editor.Tables.Areas.Array.find((function(e){return e.Name==t.RangeName}));if(void 0!==s){let r=s.Definition;void 0!==r&&(r.PlateIndex.getValue()==t.Index&&r.PlateIndex.Selected==t.Name?(t.Broken=!1,i.push(t)):r.PlateIndex.List[t.Index]==t.Name&&(void 0!==e&&0!=e.All||(t.Broken=!0),i.push(t)))}})),this.Table=i,t=i.length,0==t?Pair.unpaired():Pair.paired(this,t)}setDefPlate(){return this.Table.forEach((function(e){let t=Editor.Tables.Areas.Array.find((function(t){return t.Name==e.RangeName})).Definition;void 0!==t&&t.PlateIndex.setValue(e.Index),e.Broken=!1})),this}getDefPlate(e){let t=[];return e.forEach((function(e,i){let r=this.Table.find((function(t){return e.Name==t.RangeName}));void 0!==r&&t.push({RangeIndex:i,DefPlateIndex:r.Index})}),this),t}rename(e,t){return this.Table.forEach((function(i){i.RangeName==e&&(i.RangeName=t)})),this}}class Pairing{constructor(e){return this.Result=e,this.Pairs=Array(e.PlatesID.length),this}static form(e,t){let i="Form_Pairing",r={Def:i+"_Def",Result:i+"_Res",Auto:i+"_Auto",Preview:i+"_Preview"},s={Ranges:new RespTable({ID:r.Def,Array:t,Fields:["Name","DefInfo"],Headers:["Range","Properties"],NoControls:!0}),Results:new RespTable({ID:r.Result,Array:e,Fields:["Name","Plate Count"],NoControls:!0,onSelect:function(e){e[0],Pairing.preview(s,r.Preview)}})};Form.open({ID:i,HTML:'<fieldset style="width: 350px; float: left; overflow: auto" title="Select a result file to display the corresponding pairing table below"><legend>Results available</legend><div id="'+r.Result+'"></div></fieldset><fieldset style="width: 350px; float: left; overflow: auto"><legend>Definitions available</legend><div id="'+r.Def+'"></div></fieldset><fieldset style="width: 500px; clear: both; overflow: auto; float: left"><legend>Pairing Table</legend><div id="'+r.Preview+'" style="max-height: 300px; overflow: auto;"></div></fieldset><fieldset style="width: 200px; float: left"><legend>Auto-pairing</legend><div id="'+r.Auto+'"></div></fieldset>',Title:"Data pairing",Size:800,Buttons:[{Label:"Reset",Icon:{Type:"Reset",Space:!0,Color:"Red"},Click:function(){let e=s.Results.Selected[0];e.Pairing=new Pairing(e),Pairing.preview(s,r.Preview)},Title:"Delete all pairing data for the selected result"},{Label:"Done",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){let e=s.Results.Selected[0];Editor.ResultManager.Results.update(),Editor.ResultManager.draw(e),Form.close(i)}}],onInit:function(){let e=LinkCtrl.buttonBar([{Label:"By plate name",Click:function(){Pairing.autoPairing("Name",s),Pairing.preview(s,r.Preview)},Title:"Click to automatically pair the plates of the selected result and definition, using their names"},{Label:"By plate index",Click:function(){Pairing.autoPairing("Index",s),Pairing.preview(s,r.Preview)},Title:"Click to automatically pair the plates of the selected result and definition, using their index"}]);GetId(r.Auto).insertAdjacentElement("beforeend",e),Object.values(s).forEach((function(e){e.init()})),Pairing.preview(s,r.Preview)}})}static preview(e,t){let i=e.Results.Selected[0],r="",s=LinkCtrl.button({Label:"",Icon:{Type:"Edit"},Title:"Click here to edit the pairing for this plate"});void 0===i.Pairing&&(i.Pairing=new Pairing(i)),r='<table class="Table PreviewTable"><tr><th>Result Plate</th><th>Status</th></tr>',i.PlatesID.forEach((function(e,t){r+="<tr><td>"+e+"</td><td>";let n=i.Pairing.Pairs[t];void 0!==n?void 0!==n.state?r+=n.state().Html:r+=n:r+=Pair.unpaired().Html,r+='</td><td class="Pairing_Edit_TR">'+s.outerHTML+"</td></tr>"})),r+="</table>";let n=GetId(t);n.innerHTML=r;let a=n.getElementsByClassName("Pairing_Edit_TR"),l=a.length;for(let r=0;r<l;r++)a[r].children[0].addEventListener("click",(function(s){Pairing.editPair(i,r,e,t)}))}static editPair(e,t,i,r){let s=i.Ranges.Selected[0].Definition,n="Form_Pairing_Inner",a={Options:n+"_Options"},l={Plates:LinkCtrl.new("Select",{ID:a.Options,Default:0,List:s.PlatesID,NavBar:!0,Lookup:!0})};Form.open({ID:n,HTML:'<fieldset><legend>Plates available</legend><div id="'+a.Options+'"></div></fieldset>',Title:"Edit pairing",Buttons:[{Label:"Ok",Icon:{Type:"Ok",Space:!0,Color:"Green"},Click:function(){void 0===e.Pairing.Pairs[t]&&(e.Pairing.Pairs[t]=new Pair),e.Pairing.Pairs[t].register({RangeName:s.Area.Name,DefPlateIndex:l.Plates.getValue(),DefPlateName:l.Plates.Selected}),Pairing.preview(i,r),Form.close(n)}.bind(this)},{Label:"Cancel",Icon:{Type:"Cancel",Space:!0,Color:"Red"},Click:function(){Form.close(n)}}],onInit:function(){Object.values(l).forEach((function(e){e.init()}))}})}static setLinkedPlate(e,t,i){if(void 0===e.Pairing)this.status(i,Pair.unpaired());else{let r=e.Pairing.Pairs[t];if(void 0===r||void 0===r.setDefPlate)this.status(i,Pair.unpaired());else{let e=r.setDefPlate().state();this.status(i,e)}}}static status(e,t){let i=LinkCtrl.button({Label:"",Icon:{Type:"Setting"},Title:"Click here to edit the pairing setting",Click:function(){Editor.pairing()}}),r="";switch(t.State){case"unpaired":case"paired":r=t.Html;break;case"broken":i=LinkCtrl.button({Label:"",Icon:{Type:"Reset"},Click:function(){let t=Editor.Tables.Results.Selected[0],i=Editor.ResultManager.PlateSelect.getValue();Pairing.setLinkedPlate(t,i,e)},Title:"Click here to set the definition plates as defined in the pairing setting"}),r=t.Html}GetId(e).innerHTML=r,GetId(e).insertAdjacentElement("beforeend",i)}static update(e){let t=Editor.ResultManager.Results.Selected[0];if(void 0===t)return;let i=Editor.ResultManager.PlateSelect.getValue();if(void 0!==t.Pairing&&void 0!==t.Pairing.Pairs[i]&&void 0!==t.Pairing.Pairs[i].update){let r=t.Pairing.Pairs[i].update();Pairing.status(e,r)}}static updateAll(e){Editor.ResultManager.Results.Array.forEach((function(t){if(void 0!==t.Pairing){let i=-1;t.Selected&&(i=Editor.ResultManager.PlateSelect.getValue()),t.Pairing.Pairs.forEach((function(t,r){if(void 0!==t&&void 0!==t.update){let s=t.update({All:!0});r==i&&Pairing.status(e,s)}}))}}),this)}static resize(e){if(void 0===e.Pairing)return;let t=e.PlatesID.length,i=e.Pairing.Pairs.length;if(i!=t)if(i<t)for(;i<t;)e.Pairing.Pairs.push(new Pair),i++;else e.Pairing.Pairs.splice(t,i-t)}static rename(e,t){Editor.ResultManager.Results.Array.forEach((function(i){void 0!==i.Pairing&&i.Pairing.Pairs.forEach((function(i){void 0!==i&&void 0!==i.rename&&i.rename(e,t)}))}))}static autoPairing(e,t){let i=t.Results.Selected[0],r=t.Ranges.Selected[0].Definition,s=0,n=r.PlatesID;if("Name"==e?i.PlatesID.forEach((function(e,t){let a=n.findIndex((function(t){return t==e}));a>-1&&(void 0===i.Pairing.Pairs[t]&&(i.Pairing.Pairs[t]=new Pair),i.Pairing.Pairs[t].register({RangeName:r.Area.Name,DefPlateIndex:a,DefPlateName:n[a]}),s++)})):i.PlatesID.forEach((function(e,t){let a=n[t];void 0!==a&&(void 0===i.Pairing.Pairs[t]&&(i.Pairing.Pairs[t]=new Pair),i.Pairing.Pairs[t].register({RangeName:r.Area.Name,DefPlateIndex:t,DefPlateName:a}),s++)})),0==s)alert("no matches found!");else{let e="";s>1&&(e="es"),alert(s+" match"+e+" found")}}}class Reporter{constructor(){return this}static htmlHeader(e){let t="<!DOCTYPE HTML>\n";return t+="<html>\n",t+="<head>\n",t+='\t<meta http-equiv="content-type" content="text/html; charset=UTF-8">\n',t+="\t<title>"+e+"</title>\n",t+='\t<link href="dist/ui-styles.css" rel="stylesheet" type="text/css">\n',t+='\t<link href="dist/analyzer-styles.css" rel="stylesheet" type="text/css">\n',t+='\t<link href="dist/shared-styles.css" rel="stylesheet" type="text/css">\n',t+='\t<script type="text/javascript" src="dist/ui.min.js"><\/script>\n',t+='\t<script type="text/javascript" src="dist/shared.min.js"><\/script>\n',t+='\t<script type="text/javascript" src="dist/analyzer.min.js"><\/script>\n',t+='\t<script type="text/javascript" src="dependencies/jszip.min.js"><\/script>\n',t}static header(e){let t=e.Title||"Report",i=this.htmlHeader(e.Method);return i+='\t<script type="text/javascript">window.onload = function() {Analyzer.init({Method: "'+e.Method+'", Title: "'+t+'"})}<\/script>\n',i+="</head>\n",i+='<body style="font-family: arial; font-size: 16px">\n',i+='<div id="Header">\n',i+="\t<p><b>"+t+"</b></p>\n",i+="</div>\n",i+='<div id="Main">\n',i}static footer(){let e="</div>\n";return e+='<div id="Footer">\n',e+="\t<p>Generated&nbsp;<script>document.write(Date())<\/script>.</p>\n",e+="</div>\n",e+="</body>\n",e+="</html>\n",'</div>\n<div id="Footer">\n\t<p>Generated&nbsp;<script>document.write(Date())<\/script>.</p>\n</div>\n</body>\n</html>\n'}static openPage(e){let t=window.open();t.document.write(e),t.document.close(),t.focus()}static openReport(e,t){let i=this.header(t)+e+this.footer();this.openPage(i)}static printable(e){let t=this.htmlHeader("Printable");t+="</head>\n",t+='<body style="font-family: arial; font-size: 16px">\n',this.openPage(t+e+"\n</body></html>")}static combination(e,t){let i={};return Object.values(e).forEach((function(r,s){if(Array.isArray(r)){let n=Object.keys(e)[s],a=r;t.Conc&&(a=this.combineConc(a)),t.Tags&&(a=this.combineTags(a)),i[n]=a}}),this),i}static combineConc(e){let t=[],i=[];e.forEach((function(e){e.Conc.forEach((function(r,s){let n=e.Name;r.length>0&&(n+=" "+r);let a=t.indexOf(n);-1==a?(t.push(n),i.push([e.Tags[s]])):i[a].push(e.Tags[s])}))}));let r=[];return t.forEach((function(e,t){r.push({Name:e,Tags:i[t]})})),r}static combineTags(e){let t=[],i=[];e.forEach((function(e){e.Tags.forEach((function(r){let s=i.indexOf(r);-1==s?(i.push(r),t.push([e.Name])):t[s].push(e.Name)}))}));let r=[],s=[];return t.forEach((function(e,t){let n=e.sort().join(" / "),a=s.indexOf(n);-1==a?(s.push(n),r.push({Name:n,Tags:[i[t]]})):r[a].Tags.push(i[t])})),r}static zFactor(e){window.zFactor={Controls:this.combination(e,{Conc:!0,Tags:!0})},this.openReport("",{Title:"Control Report",Method:"zFactor"})}static aggregate(e){e.R.forEach((function(t){e.A=e.A.concat(t.Values)})),window.Aggregate={Combinations:this.combination({A:e.A},{Conc:!0,Tags:!0}),Ranges:e.R},this.openReport("",{Title:"Column Report",Method:"Aggregate"})}static grouped(e,t){window.Grouped={Areas:e.A,Conc:t,Ranges:e.R,Definitions:e.D},this.openReport("",{Title:"Grouped Report",Method:"Grouped"})}}class Unit{constructor(){}static units(){return[{Name:"M"},{Name:"mM",Root:"M",Shift:-3},{Name:"µM",Root:"M",Shift:-6},{Name:"nM",Root:"M",Shift:-9},{Name:"pM",Root:"M",Shift:-12},{Name:"g/L"},{Name:"g/mL"},{Name:"mg/mL",Root:"g/mL",Shift:-3},{Name:"µg/mL",Root:"g/mL",Shift:-6},{Name:"ng/mL",Root:"g/mL",Shift:-9},{Name:"pg/mL",Root:"g/mL",Shift:-12},{Name:"%"},{Name:"u/mL"},{Name:"ku/mL",Root:"u/mL",Shift:3},{Name:"Mu/mL",Root:"u/mL",Shift:6},{Name:"MOI",Invert:!0},{Name:"×"},{Name:"a.u"}]}static list(e){let t=this.units();return e&&e.Name?t.map((function(e){return e.Name})):t}static shiftForUnit(e){return this.units().find((function(t){return t.Name==e})).Shift||0}static rootForUnit(e){return this.units().find((function(t){return t.Name==e})).Root||e}}function GetId(e){return document.getElementById(e)}class InputObject_File extends InputObject{constructor(e){return super(),this.RawData=e,this.Source="File",this.Type=e.type,this.Name=e.name,this.Size=e.size,this.Format=e.name.substring(e.name.lastIndexOf(".")),".xlsx"==this.Format&&(this.Controls.Parser.Value=1),".xls"==this.Format&&(this.Controls.Parser.Value=2),this.InputParser=InputParser.new({Type:this.Controls.Parser.Selected,Data:this.RawData,Name:this.Name}),this}}class InputObject_Manual extends InputObject{constructor(e){super();var t=e.Data;return void 0===t?(console.warn("No data transfered to InputObject manual. Aborted"),this):(this.RawData=t,this.Source="Manual",this.Type="txt/plain",this.Size=t.length,e.Name&&e.Name.length>0?this.Name=e.Name:(this.Name=t.substring(0,7),this.Size>7&&(this.Name+="[...]")),this.Format="-",this.Controls.Parser.List=["TXT/CSV"],this.InputParser=InputParser.new({Type:this.Controls.Parser.Selected,Data:this.RawData,Name:this.Name}),this)}}class InputParser_Papa extends InputParser{constructor(e){super(e),this.Type="Papa",this.Help="Parsing of text or csv files, based on the PapaParse library";let t=Form_Import.Anchors.ParserOptions;Object.assign(this.Options,{delimiter:LinkCtrl.new("Text",{ID:t,Label:"Delimiter",Default:"",Preserve:!0,Index:5,Size:5,Change:function(){this.parse()}.bind(this),Title:"Delimiter used for parsing columns. Leave empty for auto-detection"})})}init(){Object.values(this.Options).forEach((function(e){e.init()}));let e=LinkCtrl.button({ID:"insert-Tab",Label:"TAB",Title:"Click to insert a Tabulation",Click:function(){this.Options.delimiter.setValue("\t").change()}.bind(this)});return GetId(Form_Import.Anchors.ParserOptions).insertAdjacentElement("beforeend",e),this}assignOptions(e){let t=Object.entries(this.Options).map((function(e){return[e[0],e[1].getValue()]}));return Object.assign(e,Object.fromEntries(t)),e}firstParse(e){this.TotalCols=0,this.TotalRows=0;let t={worker:this.WebWorker,header:!1,step:function(t,i){i.FirstParsed=!1;let r=t.data.length;r>this.TotalCols&&(this.TotalCols=r),this.TotalRows++,e&&e.Step&&e.Step(t.data,this.TotalRows,i)}.bind(this),complete:function(){this.FirstParsed=!0,this.parse(e)}.bind(this),error:function(t){this.Error=!0,this.ErrorDetails=t,this.parse(e),e&&e.Error&&e.Error(t)}.bind(this)};Papa.parse(this.RawData,this.assignOptions(t))}stream(e,t,i){let r=this.parsingOptions();i&&i.ApplyToHeader&&(r.ApplyToHeader=!0);let s={header:!1,worker:this.WebWorker,step:function(t,i){i.FirstParsed=this.FirstParsed,this.processRow(t.data,i,e,r)}.bind(this),complete:function(){t&&t(r.Selected,r)}};Papa.parse(this.RawData,this.assignOptions(s))}}class InputParser_XLS extends InputParser{constructor(e){super(e),this.Type="XLS",this.Help="Parsing of .xls Excel files with streaming capabilities";let t=Form_Import.Anchors.ParserOptions;this.Options=Object.assign(this.Options,{Sheet:LinkCtrl.new("Select",{ID:t,Label:"Sheet",Default:0,List:[],Preserve:!0,NewLine:!0,Index:5,Change:function(){this.Worker&&this.Worker.terminate(),this.FirstParsed=!1,this.parse()}.bind(this),Title:"The sheet to import"})}),this.Worker=void 0,this.SharedStrings=void 0}static getMeta(e){return new Promise((function(t,i){let r=new FileReader;r.onerror=function(e){i(r.error)},r.onload=function(r){let s=r.target.result,n=new DataView(r.target.result);try{InputParser_XLS.getOffsets(e,n);let t=InputParser_XLS.getSheets(e,s,n);6==e.BIFFversion&&InputParser_XLS.getSharedStrings(e,s,n,t)}catch(r){return void i(r)}t()},r.readAsArrayBuffer(e.RawData)}))}static getOffsets(e,t){switch(t.getUint16(26,!0)){case 3:e.SectorSize=512;break;case 4:e.SectorSize=4096;break;default:throw new Error("Unknown CPF version")}let i=(t.getUint32(48,!0)+1)*e.SectorSize;e.DirStreamOffset=i,e.StreamSize=(t.getUint32(i+128+124,!0)<<32)+t.getUint32(i+128+120,!0)}static getSheets(e,t,i){let r=i.getUint32(e.DirStreamOffset+128+116,!0),s=(r+1)*e.SectorSize;e.WorkbookSector=r,e.WorkbookOffset=s;let n=s+4;e.BIFFversion=i.getUint16(n,!1),n+=4;let a=i.getUint16(n,!0),l=i.byteLength;for(;133!=a&&n<l;)n+=1,a=i.getUint16(n,!0);if(133!=a)throw new Error("Could not find BoundSheet stream...");n+=2,e.Sheets=[];let o=[],h=!0;for(;h&&n<l;){let r=i.getUint32(n+2,!0)+s,a=i.getUint8(n+6,!0);n+=8;let l=i.getUint16(n,!0);if(e.BIFFversion<6?(l=i.getUint8(n,!0),n+=1):n+=2,0==a){let i=new TextDecoder("windows-1252"),s=new Uint8Array(t,n,l),a=i.decode(s);e.Sheets.push({Name:a,Offset:r}),o.push(a)}n+=l,133!=i.getUint16(n,!0)?h=!1:n+=2}if(n>l)throw new Error("EOF reached after sheets metadata");let c=e.Sheets.length-1;for(let t=0;t<c;t++){let i=e.Sheets[t];i.Length=e.Sheets[t+1].Offset-i.Offset}return e.Sheets[c].Length=e.StreamSize,e.Options.Sheet.updateList(o),n}static getSharedStrings(e,t,i,r){e.SharedStrings=[];let s=i.getUint16(r,!0),n=i.byteLength;for(;252!=s&&r<n;)r+=1,s=i.getUint16(r,!0);if(252!=s)throw new Error("Could not find SharedString stream...");let a=i.getUint16(r+2,!0),l=12;for(;l<a;){let s=this.parseString(t,i,r+l);e.SharedStrings.push(s.Str),l+=s.Offset}}static buildSheetAB(e,t,i,r,s,n){if(6==n)return e.slice(t.Offset,t.Offset+t.Length);let a=new DataView(e),l=InputParser_XLS.getFatArray(a,i),o=new Uint8Array(e.byteLength),h=i/4,c=0,u=Math.floor(s/h),d=a.getInt32(l[u]+4*s,!0),p=r,f=new Uint8Array(e.slice(p,p+i));for(o.set(f);d>-1;)p=(d+1)*i,f=new Uint8Array(e.slice(p,p+i)),o.set(f,(c+1)*i),c++,u=Math.floor(d/h),d=a.getInt32(l[u]+4*(d-u*h),!0);return p=t.Offset-r,o.buffer.slice(p,p+t.Length)}static getFatArray(e,t){let i=e.getUint32(44,!0),r=[],s=76,n=e.getInt32(76,!0);for(;-1!=n&&s<512;)r.push((n+1)*t),s+=4,n=e.getInt32(s,!0);if(e.getUint32(72,!0)>0){let a=109;for(s=(e.getUint32(68,!0)+1)*t,n=e.getInt32(s,!0);-1!=n&&a<i;)r.push((n+1)*t),s+=4,a++,n=e.getInt32(s,!0)}return r}static parseString(e,t,i){let r=new TextDecoder("windows-1252"),s=t.getUint16(i,!0),n=t.getUint8(i+2,!0),a=3,l=1&n,o=8&n,h=0;4&n&&(h+=t.getUint32(i+a,!0),a+=4),o&&(h+=4*t.getUint16(i+a,!0),a+=2);let c=[];return l?(r=new TextDecoder("utf-8"),s*=2,c=new Uint16Array(e,i+a,s)):c=new Uint8Array(e,i+a,s),{Str:r.decode(c),Offset:a+h+s}}static initWorker(e){let t="";t+="self.cell = "+function(e,t,i){let r=self.Cursor,s=t.getUint16(r,!0),n=t.getUint16(r+2,!0),a={Row:t.getUint16(r+4,!0),Col:t.getUint16(r+6,!0),Value:void 0,Done:!1};switch(s){case 253:a.Value=i[t.getUint32(r+10,!0)];break;case 515:a.Value=t.getFloat64(r+10,!0);break;case 126:case 638:a.Value=self.parseRK(r+10,t);break;case 189:a.Value=self.parseRK(r+10,t),a.More=[];let s=r+16,l=r+n+2;for(;s<l;)a.More.push(self.parseRK(s,t)),s+=6;break;case 215:a.Done=!0;break;case 6:case 518:case 1030:let o=[];for(let e=0;e<8;e++)o.push(t.getUint8(r+10+e,!0));if(255==o[6]&&255==o[7])switch(o[0]){case 0:let i=self.parseString(e,t,r+n+8);a.Value=i.Str,self.Cursor+=i.Offset+4;break;case 1:0==o[2]?a.Value="FALSE":a.Value="TRUE";break;case 2:switch(o[2]){case 0:a.Value="#NULL!";break;case 7:a.Value="#DIV/0!";break;case 15:a.Value="#VALUE!";break;case 23:a.Value="#REF!";break;case 29:a.Value="#NAME?";break;case 36:a.Value="#NUM!";break;case 42:a.Value="#N/A"}}else a.Value=t.getFloat64(r+10,!0);break;case 516:case 214:let h=new TextDecoder("windows-1252"),c=new Uint8Array(e,r+12,t.getUint16(r+10,!0));a.Value=h.decode(c);break;case 513:case 190:case 517:break;default:a.Done=!0}return self.Cursor+=n+4,a}.toString()+"; ",t+="self.parseRK = "+function(e,t){let i=t.getUint8(e,!0),r=1&i,s=void 0;if(2==(2&i))s=t.getInt32(e,!0)>>2;else{let r=[i,t.getUint8(e+1,!0),t.getUint8(e+2,!0),t.getUint8(e+3,!0)],n=1-2*(r[3]>>7),a=((r[3]<<1&255)<<3|r[2]>>4)-1023,l=(15&r[2])*Math.pow(2,48)+r[1]*Math.pow(2,40)+(252&r[0])*Math.pow(2,32);if(1024==a)return 0!=l?NaN:n*(1/0);s=-1023==a?n*l*Math.pow(2,-1074):n*(1+l*Math.pow(2,-52))*Math.pow(2,a)}return 1==r?s/100:s}.toString()+"; ",t+="self.metaSheet = "+function(e,t,i){if(2057!=e.getUint16(0,!0))throw new Error("Sheet BOF location incorrect");let r=e.getUint16(2,!0)+4,s=e.getUint16(4,!1);if(self.BIFF=s,6==s){if(523!=e.getUint16(r,!0))throw new Error("No index available after BOF");e.getUint16(r+2,!0);let i=e.getUint32(r+8,!0),s=e.getUint32(r+12,!0);self.BIFFversion<6?(i=e.getUint16(r+8,!0),s=e.getUint16(r+10,!0),r+=16):r+=20;let n=Math.ceil((s-i)/32),a=[];for(let i=0;i<n;i++)a.push(e.getUint32(r+4*i,!0)+t);if(0==a.length)throw new Error("Could not find any Row bloc offset");self.Blocs=a}else{let t=e.byteLength,i=e.getUint16(r,!0);for(;520!=i&&r<t;)r+=1,i=e.getUint16(r,!0);if(520!=i)throw new Error("Could not find Cell Table stream...");for(;520==i&&r<t;)r+=20,i=e.getUint16(r,!0);if(r>=t)throw new Error("Could not find any Cell records...");self.FirstCellOffset=r}}.toString()+"; ",t+="self.parse = "+function(e,t,i,r,s){if(self.RowIndex=0,self.Blocs){let n=self.Blocs.length;self.Blocs.forEach((function(a,l){let o=a-i,h=o-t.getUint32(o+4,!0)+20+t.getUint16(o+8,!0);end=l==n-1?s:this.Blocs[l+1]-i,this.getRows(e,t,r,h,end)}),self)}else this.getRows(e,t,void 0,self.FirstCellOffset,e.byteLength)}.toString()+"; ",t+="self.getRows = "+function(e,t,i,r,s){self.Cursor=r;let n=[],a=!1;for(;!a&&self.Cursor<s;){let r=self.cell(e,t,i);if(a=r.Done,a)postMessage({Row:n}),self.RowIndex++;else{let e=r.Row;for(;self.RowIndex<e&&self.RowIndex<65536;)postMessage({Row:n}),n=[],self.RowIndex++;n[r.Col]=r.Value,void 0!==r.More&&r.More.forEach((function(e,t){n[r.Col+t+1]=e}))}}}.toString()+"; ",t+="self.parseString = "+this.parseString.toString().replace("parseString","function")+"; ",t+="self.Cursor = 0; ",t+="self.BIFFversion = "+e.BIFFversion+"; ",t+="onmessage = "+function(e){let t=e.data.Buffer,i=t.byteLength,r=e.data.SharedStrings,s=e.data.WBoffset;offset=e.data.SheetOffset;let n=new DataView(t);self.metaSheet(n,s,i),self.parse(t,n,offset,r,i),postMessage({Done:!0})}.toString()+";";let i=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(i))}firstParse(e){this.TotalCols=0,this.TotalRows=0,InputParser_XLS.getMeta(this).then(function(){this.stream(function(t,i,r){let s=t.length;s>this.TotalCols&&(this.TotalCols=s),this.TotalRows++,e&&e.Step&&e.Step(t,this.TotalRows,r)}.bind(this),function(){this.FirstParsed=!0,this.parse(e)}.bind(this),e)}.bind(this),function(t){this.Error=!0,this.ErrorDetails=t,this.parse(e),e&&e.Error&&e.Error(t)}.bind(this))}stream(e,t,i){let r=InputParser_XLS.initWorker(this);this.Worker=r;let s=this.parsingOptions();i&&i.ApplyToHeader&&(s.ApplyToHeader=!0);let n=new FileReader,a=function(e){this.Error=!0,this.ErrorDetails=e,i&&i.Error&&i.Error(e),this.parseEnd(r,s,t)}.bind(this);n.onerror=function(e){a(n.error)},n.onload=function(e){let t=e.target.result,i=this.Sheets[this.Options.Sheet.getValue()],s=InputParser_XLS.buildSheetAB(t,i,this.SectorSize,this.WorkbookOffset,this.WorkbookSector,this.BIFFversion);r.postMessage({Buffer:s,SharedStrings:this.SharedStrings,WBoffset:this.WorkbookOffset,SheetOffset:i.Offset},[s])}.bind(this);let l={abort:function(){this.parseEnd(r,s,t)}.bind(this),FirstParsed:this.FirstParsed};r.onmessage=function(i){i.data.Done?this.parseEnd(r,s,t):this.processRow(i.data.Row,l,e,s)}.bind(this),r.onmessageerror=function(e){a(e.message)},r.onerror=function(e){a(e.message)},n.readAsArrayBuffer(this.RawData)}parseEnd(e,t,i){e.terminate(),this.Worker=void 0,i&&i(t.Selected,t)}}class InputParser_XLSX extends InputParser{constructor(e){super(e),this.Type="XLSX",this.Help="Parsing of .xlsx Excel files with streaming capabilities";let t=Form_Import.Anchors.ParserOptions;this.Options=Object.assign(this.Options,{Sheet:LinkCtrl.new("Select",{ID:t,Label:"Sheet",Default:0,List:[],Preserve:!0,NewLine:!0,Index:5,Change:function(){this.Worker&&this.Worker.terminate(),this.FirstParsed=!1,this.parse()}.bind(this),Title:"The sheet to import"})}),this.Worker=void 0,this.ZIP=void 0,this.SharedStrings=void 0}static getSheetNames(e,t){return new Promise(function(i,r){e.file("xl/workbook.xml").async("string").then((function(e){let r=t.parseFromString(e,"application/xml").getElementsByTagName("sheet"),s=r.length,n=Array(s);for(let e=0;e<s;e++){n[Number(r[e].attributes.sheetId.value)-1]=r[e].attributes.name.value}i(n)}),(function(e){r(e)}))}.bind(this))}static getSharedStrings(e,t){return new Promise(function(i,r){e.file("xl/sharedStrings.xml").async("string").then((function(e){let r=t.parseFromString(e,"application/xml").getElementsByTagName("t"),s=r.length,n=[];for(let e=0;e<s;e++)n.push(r[e].innerHTML);i(n)}),(function(e){r(e)}))}.bind(this))}static getMeta(e,t){let i=new DOMParser;return new Promise(function(r,s){let n=[this.getSheetNames(t,i),this.getSharedStrings(t,i)];Promise.all(n).then((function(t){e.Options.Sheet.updateList(t[0]),e.SharedStrings=t[1],r()}),(function(e){s(e)}))}.bind(this))}static initWorker(){let e=new Blob(["self.MaxChunkSize = 1024 * 1024; self.LastRow = undefined; self.Position = 0; onmessage = "+function(e){let t=e.data.Buffer,i=e.data.SharedStrings,r=self.MaxChunkSize,s=t.byteLength;for(;self.Position<s;){self.Position+self.MaxChunkSize>s&&(r=s-self.Position);let e=new Uint8Array(t,self.Position,r),n=new TextDecoder("utf-8").decode(e);self.LastRow&&(n=self.LastRow+n),n.split('<row r="').forEach((function(e,t){let r=e.indexOf("</row>");if(r>-1){let t=e.substring(0,e.indexOf('"')),s=[],n=0;e.split('<c r="').forEach((function(e,r){if(r>0){let r=e.substring(0,e.indexOf('"')-t.length),a=-1;for(r.split("").forEach((function(e,t){a+="*ABCDEFGHIJKLMNOPQRSTUVWXYZ".indexOf(e)*Math.pow(26,r.length-t-1)}));n<a;)n++,s.push("");let l=e.indexOf("<v>");if(l>-1){let t=e.substring(l+3,e.indexOf("</v>")),r=e.match(/t="(.+?)"/);if(null!==r)switch(r[1]){case"b":t?s.push("TRUE"):s.push("FALSE");break;case"s":s.push(i[Number(t)]);break;default:s.push(t)}else s.push(Number(t))}else s.push("");n++}})),postMessage({Row:s});let a=e.substring(r+6);0==a.length?self.LastRow=void 0:self.LastRow=a}else self.LastRow=e})),self.Position+=self.MaxChunkSize}postMessage({Done:!0})}.toString()],{type:"application/javascript"});return new Worker(URL.createObjectURL(e))}firstParse(e){this.TotalCols=0,this.TotalRows=0,JSZip.loadAsync(this.RawData).then(function(t){this.ZIP=t,InputParser_XLSX.getMeta(this,t).then(function(){this.stream(function(t,i,r){let s=t.length;s>this.TotalCols&&(this.TotalCols=s),this.TotalRows++,e&&e.Step&&e.Step(t,this.TotalRows,r)}.bind(this),function(){this.FirstParsed=!0,this.parse(e)}.bind(this),e)}.bind(this))}.bind(this),function(t){this.Error=!0,this.ErrorDetails=t,this.parse(e),e&&e.Error&&e.Error(t)}.bind(this))}stream(e,t,i){let r=InputParser_XLSX.initWorker();this.Worker=r;let s=this.ZIP.file("xl/worksheets/sheet"+(this.Options.Sheet.getValue()+1)+".xml"),n=this.parsingOptions(),a=function(e){this.Error=!0,this.ErrorDetails=e,i&&i.Error&&i.Error(e),this.parseEnd(r,n,t)}.bind(this);s.async("arraybuffer").then(function(s){i&&i.ApplyToHeader&&(n.ApplyToHeader=!0);let l={abort:function(){r.terminate(),this.Worker=void 0,t&&t(n.Selected,n)}.bind(this),FirstParsed:this.FirstParsed};r.onmessage=function(i){i.data.Done?this.parseEnd(r,n,t):this.processRow(i.data.Row,l,e,n)}.bind(this),r.onmessageerror=function(e){a(e.message)},r.onerror=function(e){a(e.message)},r.postMessage({Buffer:s,SharedStrings:this.SharedStrings},[s])}.bind(this))}parseEnd(e,t,i){e.terminate(),this.Worker=void 0,i&&i(t.Selected,t)}}class Mapper_Direct extends Mapper{constructor(e){return super(),this}scan(e,t,i){return new Promise((function(r){e.Parser.stream((function(r,s,n){t.MinMax&&Mapper.scanMinMax(e,r),t.Preview&&(Mapper.scanPreviewColumns(i,r,i.Items+1+"."),1==i.LimitReached&&t.Preview.Interrupt&&n.abort()),i.Items++,t.Custom&&t.Custom(void 0,void 0,r,i,n)}),(function(e){t.Log&&(i.PlatesID=void 0),r(i)}))}))}find(e,t){let i=Number(t.Plate),r=t.Default,s=(i-1)*t.Factor,n=i*t.Factor,a=0;return t.FindAll&&(r=[]),new Promise((function(i){e.Parser.stream((function(e,i,l){i==n?l.abort():i>=s&&(t.FindAll?r.push(e[t.Column]):a==t.RangeIndexBase0&&(r=e[t.Column],l.abort()),a++)}),(function(e){r=Mapper.fillMissingElements(r,t,s,a),i(r)}))}))}}class Mapper_Plate extends Mapper{constructor(e){return super(),this.PlateCol=e[Mapper.plate().Name],this}scan(e,t,i){let r=this.PlateCol;return new Promise((function(s){e.Parser.stream((function(s,n,a){void 0!==s[r]&&(t.Log&&0==i.PlatesID.includes(s[r])&&i.PlatesID.push(s[r]),t.MinMax&&Mapper.scanMinMax(e,s),t.Preview&&(Mapper.scanPreviewColumns(i,s,s[r]+"."),1==i.LimitReached&&t.Preview.Interrupt&&a.abort()),i.Items++,t.Custom&&t.Custom(void 0,s[r],s,i,a))}),(function(){s(i)}))}))}find(e,t){let i=this.PlateCol,r=0,s=t.Default;return t.FindAll&&(s=[]),new Promise((function(n){e.Parser.stream((function(e,n,a){void 0!==e[i]&&e[i]==t.Plate&&(t.FindAll?s.push(e[t.Column]):r==t.RangeIndexBase0&&(s=e[t.Column],a.abort()),r++)}),(function(){s=Mapper.fillMissingElements(s,t,0,r),n(s)}))}))}}class Mapper_PlateWell extends Mapper{constructor(e){return super(),this.WellCol=e[Mapper.well().Name],this.PlateCol=e[Mapper.plate().Name],this}scan(e,t,i){let r=Editor.Plate;if(void 0===r)return Promise.resolve({Error:"No plate defined, cannot validate the well data now"});let s=this.WellCol,n=this.PlateCol;return new Promise((function(a){e.Parser.stream((function(a,l,o){let h=Well.parseIndex(a[s],r);void 0!==h&&void 0!==a[n]&&(t.Log&&0==i.PlatesID.includes(a[n])&&i.PlatesID.push(a[n]),t.MinMax&&Mapper.scanMinMax(e,a),t.Preview&&(Mapper.scanPreviewColumns(i,a,a[n]+". "+a[s]+"."),1==i.LimitReached&&t.Preview.Interrupt&&o.abort()),i.Items++,t.Custom&&t.Custom(h,a[n],a,i,o))}),(function(){a(i)}))}))}find(e,t){let i=Editor.Plate;if(void 0===i)return Promise.resolve("");let r=this.WellCol,s=this.PlateCol,n=t.Default;return t.FindAll&&(n=Array(i.Rows*i.Cols).fill(t.Default)),new Promise((function(a){e.Parser.stream((function(e,a,l){let o=Well.parseIndex(e[r],i);void 0!==o&&void 0!==e[s]&&e[s]==t.Plate&&(t.FindAll?n[o.Index]=e[t.Column]:o.Index==t.Well&&(n=e[t.Column],l.abort()))}),(function(){a(n)}))}))}}class Mapper_Well extends Mapper{constructor(e){return super(),this.WellCol=e[Mapper.well().Name],this}scan(e,t,i){let r=Editor.Plate;if(void 0===r)return Promise.resolve({Error:"No plate defined, cannot validate the well data now"});i.PlatesID=Array(r.Rows*r.Cols).fill(0);let s=this.WellCol;return new Promise((function(n){e.Parser.stream((function(n,a,l){let o=Well.parseIndex(n[s],r);void 0!==o&&(i.PlatesID[o.Index]++,t.MinMax&&Mapper.scanMinMax(e,n),t.Preview&&(Mapper.scanPreviewColumns(i,n,n[s]+"."),1==i.LimitReached&&t.Preview.Interrupt&&l.abort()),i.Items++,t.Custom&&t.Custom(o,i.PlatesID[o.Index],n,i,l))}),(function(){if(t.Log){let e=0;i.PlatesID.forEach((function(t){t>e&&(e=t)}));let t=[];for(let i=0;i<e;i++)t.push(i+1);i.PlatesID=t}n(i)}))}))}find(e,t){let i=Editor.Plate;if(void 0===i)return Promise.resolve("");let r=this.WellCol;t.Plate=Number(t.Plate)-1;let s=0,n=t.Default;return t.FindAll&&(n=Array(i.Rows*i.Cols).fill(t.Default),s=Array(i.Rows*i.Cols).fill(0)),new Promise((function(a){e.Parser.stream((function(e,a,l){let o=Well.parseIndex(e[r],i);void 0!==o&&(t.FindAll?(s[o.Index]==t.Plate&&(n[o.Index]=e[t.Column]),s[o.Index]++):o.Index==t.Well&&(s==t.Plate?(n=e[t.Column],l.abort()):s++))}),(function(){a(n)}))}))}}
//# sourceMappingURL=shared.min.js.map
